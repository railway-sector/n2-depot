"use strict";(self.webpackChunkn2_depot=self.webpackChunkn2_depot||[]).push([[4429,7933],{16175:(e,t,i)=>{i.d(t,{A:()=>f});var n=i(89379),r=i(6326),s=i(50076),o=i(46053),l=(i(81806),i(76460),i(47249),i(87990)),a=i(65215),c=i(85396),u=i(61229),h=i(52494),d=i(59844),m=i(77725);let f=class extends c.A{constructor(){super(...arguments),this.datasetFormat="Function",this.tileType="Raster",this.rasterFunction=null,this._clippingGeometry=new Map}async fetchPixels(e,t,i){var r,s,o;let l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const{rasters:a,rasterIds:c}=this.primaryRasters;let d=!1;const{interpolation:m}=l,f=null===(r=this.rasterFunction.flatWebGLFunctionChain)||void 0===r?void 0:r.hasFocalFunction;!l.requestRawData&&f&&(d=1===a.length&&!l.skipRasterFunction,l=(0,n.A)((0,n.A)({},l),{},{interpolation:"bilinear",requestRawData:d})),l.requestRawData&&a.length>1&&!this.hasUniqueSourceStorageInfo&&(d=!1,l=(0,n.A)((0,n.A)({},l),{},{requestRawData:!1}));const p=a.map(n=>n.fetchPixels(e,t,i,l)),g=await Promise.all(p),y=g.map(e=>e.pixelBlock),v=d||l.requestRawData?g.map(e=>e.srcTilePixelSize):null;if(l.skipRasterFunction||y.every(e=>null==e))return g[0];const x=null!==(s=null===(o=g.find(e=>null!=e.pixelBlock))||void 0===o?void 0:o.extent)&&void 0!==s?s:e;let I=this.rasterJobHandler?await this.rasterJobHandler.process({extent:x,primaryPixelBlocks:y,primaryPixelSizes:v,primaryRasterIds:c}):this.rasterFunction.process({extent:x,primaryPixelBlocks:y,primaryPixelSizes:v,primaryRasterIds:c});const{transformGrid:_}=g[0];if(!d||null==I||null==_){const e=l.noClip?null:this.getClippingGeometry(x.spatialReference);return!l.noClip&&null!=I&&e&&(I=await(0,u.$Q)(I,x,e)),(0,n.A)((0,n.A)({},g[0]),{},{pixelBlock:I})}const R={rows:_.spacing[0],cols:_.spacing[1]};let b;b=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[I],srcMosaicSize:{width:I.width,height:I.height},destDimension:{width:t,height:i},coefs:_.coefficients,sampleSpacing:R,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:m,alignmentInfo:void 0,blockWidths:null},l)).pixelBlock:(0,h.$i)(I,{width:t,height:i},_.coefficients,R,m);const w=l.noClip?null:this.getClippingGeometry(e.spatialReference);return l.noClip||null==b||null==w||(b=await(0,u.$Q)(b,e,w)),{extent:e,srcExtent:g[0].srcExtent,pixelBlock:b}}getClippingGeometry(e){const t=this._clippingGeometry.get("0");if(!e||!t)return t;const i=function(e){var t,i;return String(null!==(t=null!==(i=e.wkid)&&void 0!==i?i:e.wkt)&&void 0!==t?t:e.wkt2)}(e);let n=this._clippingGeometry.get(i);return null!=n||(n=e.equals(t.spatialReference)?t:(0,d.uk)(t,e),this._clippingGeometry.set(i,n)),n}async _open(e){var t,i,n,r;const{rasterFunction:o}=this;o.isRoot=!0,null!==(t=this.primaryRasters)&&void 0!==t&&null!==(t=t.rasters)&&void 0!==t&&t.length?o.sourceRasters=this.primaryRasters.rasters:(this.primaryRasters=o.getPrimaryRasters(),this.rasterJobHandler&&(null===(i=this.primaryRasters.rasters)||void 0===i||i.forEach(e=>e.rasterJobHandler=this.rasterJobHandler)));const{rasters:l,rasterIds:a}=this.primaryRasters,c=l.map(t=>t.rasterInfo?void 0:t.open(e));await Promise.all(c);const u=l.map(e=>{let{rasterInfo:t}=e;return t}),h=o.bind({rasterInfos:u,rasterIds:a});if(o.rawSourceRasterInfos=u,!h.success||0===u.length)throw new s.A("raster-function:open","cannot bind the function: ".concat(null!==(n=h.error)&&void 0!==n?n:""));const d="Table"===o.functionName?o:null===(r=o.functionArguments)||void 0===r?void 0:r.raster;"Table"===(null===d||void 0===d?void 0:d.functionName)&&(o.rasterInfo.attributeTable=m.A.fromJSON(d.functionArguments.attributeTableAsRecordSet)),await this.syncJobHandler();const f=u[0];this.hasUniqueSourceStorageInfo=1===u.length||u.slice(1).every(e=>function(e,t){const{storageInfo:i,pixelSize:n,spatialReference:r,extent:s}=e,{storageInfo:o,pixelSize:l,spatialReference:a,extent:c}=t;return n.x===l.x&&n.y===l.y&&r.equals(a)&&s.equals(c)&&i.blockHeight===o.blockHeight&&i.blockWidth===o.blockWidth&&i.maximumPyramidLevel===o.maximumPyramidLevel&&i.firstPyramidLevel===o.firstPyramidLevel&&i.pyramidBlockWidth===o.pyramidBlockWidth&&i.pyramidBlockHeight===o.pyramidBlockHeight&&i.pyramidScalingFactor===o.pyramidScalingFactor}(e,f)),this.set("sourceJSON",l[0].sourceJSON),this.set("rasterInfo",o.rasterInfo),await this._updateClipGeometry()}async syncJobHandler(){var e;return null===(e=this.rasterJobHandler)||void 0===e?void 0:e.updateRasterFunction(this.rasterFunction)}async _updateClipGeometry(){const e=this.rasterFunction.getClippingGeometries()[0];let t=null===e||void 0===e?void 0:e.clippingGeometry;if(t&&"inside"===e.clippingType){const{extent:e}=this.rasterInfo,n=await Promise.all([i.e(6871),i.e(6364),i.e(6175),i.e(426),i.e(8609)]).then(i.bind(i,8609)),r=await Promise.all([i.e(6871),i.e(6364),i.e(6175),i.e(426),i.e(7568)]).then(i.bind(i,27568));let s=n.execute(a.A.fromExtent(e),2*(e.width+e.height)/40);s=(0,d.uk)(s,t.spatialReference),t=r.execute(s,t)}this._clippingGeometry.clear(),t&&this._clippingGeometry.set("0",t)}};(0,r.Cg)([(0,o.MZ)({type:String,json:{write:!0}})],f.prototype,"datasetFormat",void 0),(0,r.Cg)([(0,o.MZ)()],f.prototype,"tileType",void 0),(0,r.Cg)([(0,o.MZ)()],f.prototype,"rasterFunction",void 0),(0,r.Cg)([(0,o.MZ)()],f.prototype,"primaryRasters",void 0),f=(0,r.Cg)([(0,l.$)("esri.layers.support.rasterDatasets.FunctionRaster")],f)},24709:(e,t,i)=>{i.d(t,{o:()=>H});var n=i(89379),r=i(6326),s=i(3825),o=i(50076),l=i(76460),a=i(46053),c=i(40565),u=(i(81806),i(47249),i(6409)),h=i(28379),d=i(87990),m=i(19247),f=i(13312),p=i(80963),g=i(13096),y=i(95363),v=i(15359),x=i(13023),I=i(58646),_=i(44038),R=i(88235),b=i(17775),w=i(16175),S=i(68347),A=i(61229),k=i(81633),C=i(59844),T=i(86866),M=i(78937),P=i(20118),F=i(88205),B=i(46570),D=i(39128),z=i(76400),N=i(56333);const H=e=>{const t=e;let H=class extends t{constructor(){var e;super(...arguments),this._isConstructedFromFunctionRaster=!1,this.bandIds=null,this.copyright=null,this.interpolation=null,this.multidimensionalSubset=null,this.raster=null,this.serviceRasterInfo=null,this.sourceJSON=null,this.spatialReference=null,this.symbolizer=null,this._isConstructedFromFunctionRaster=(0,b.qg)(null===(e=arguments.length<=0?void 0:arguments[0])||void 0===e?void 0:e.raster)}destroy(){this._shutdownJobHandler()}get fullExtent(){var e;return null===(e=this.serviceRasterInfo)||void 0===e?void 0:e.extent}set multidimensionalDefinition(e){this._set("multidimensionalDefinition",e),this.updateRenderer()}set rasterFunction(e){var t;"none"===(null===(t=e)||void 0===t||null===(t=t.functionName)||void 0===t?void 0:t.toLowerCase())&&(e=void 0),this._set("rasterFunction",e),this.updateRasterFunction()}set url(e){this._set("url",(0,g.Jf)(e,l.A.getLogger(this)))}get renderer(){if("imagery-tile"!==this.type)return this.internalRenderer;const{activePresetRendererName:e,presetRenderers:t}=this;if(e){const i=null===t||void 0===t?void 0:t.find(t=>{let{name:i}=t;return i===e});return null===i||void 0===i?void 0:i.renderer.clone()}return this.internalRenderer}set renderer(e){"imagery-tile"===this.type&&(this.activePresetRendererName=null),this.internalRenderer=e}set internalRenderer(e){null==e&&null==this.rasterFunction?this._configDefaultRenderer("override"):(this._set("internalRenderer",e),this.updateRenderer())}readRenderer(e,t,i){var n;const r=null===t||void 0===t||null===(n=t.layerDefinition)||void 0===n||null===(n=n.drawingInfo)||void 0===n?void 0:n.renderer;return(0,F.LF)(r,i)||void 0}async computeStatisticsHistograms(e,t){var i;await this.load(t),e=(0,c.PZ)(B.A,e).clone();const{serviceRasterInfo:r}=this;if(null==r)throw new o.A("imagery-tile-mixin:compute-statistics-histograms","serviceRasterInfo must be specified");const{geometry:s}=e;if(null==s)throw new o.A("imagery-tile-mixin:compute-statistics-histograms","geometry must be specified");let l=s;const{spatialReference:a}=r;if(!s.spatialReference.equals(a)){await(0,C.Hh)();const e="extent"===s.type?(0,C._l)(s,a):(0,C.uk)(s,a);if(null==e)throw new o.A("imagery-tile-mixin:compute-statistics-histograms","geometry cannot be projected to the data source");l=e}const u=null!==(i=e.pixelSize)&&void 0!==i?i:new m.A({x:r.pixelSize.x,y:r.pixelSize.y,spatialReference:a}),{extent:h,width:d,height:f}=(0,A.b7)(r,l,u),p=await this.fetchPixels(h,d,f,(0,n.A)((0,n.A)({},t),{},{interpolation:"nearest"}));if(null==p.pixelBlock)throw new o.A("imagery-tile-mixin:compute-statistics-histograms","failed to fetch pixels");const g=await(0,A.$Q)(p.pixelBlock,h,l),y=this._rasterJobHandler;return y?y.computeStatisticsHistograms({pixelBlock:g},t):(0,T.eH)(g)}normalizeRasterFetchOptions(e){var t,i;const{multidimensionalInfo:r}=null!==(t=this.serviceRasterInfo)&&void 0!==t?t:{};if(null==r)return e;const s=(0,S.XU)({rasterInfo:this.raster.rasterInfo,multidimensionalDefinition:e.multidimensionalDefinition||this.multidimensionalDefinition,timeExtent:null!==(i=e.timeExtent)&&void 0!==i?i:this.timeExtent,multidimensionalSubset:this.multidimensionalSubset});return(0,n.A)((0,n.A)({},e),{},{multidimensionalDefinition:s,timeExtent:void 0})}async updateRasterFunction(){var e;return this.loaded&&"imagery-tile"===this.type&&(this.rasterFunction||this._cachedRasterFunctionJson)&&JSON.stringify(this.rasterFunction)!==JSON.stringify(this._cachedRasterFunctionJson)?(this._cachedRasterFunctionJson=null===(e=this.rasterFunction)||void 0===e?void 0:e.toJSON(),this._rasterFunctionUpdatePromise=this._updateRasterFunction(),this._rasterFunctionUpdatePromise):this._rasterFunctionUpdatePromise}async updateRenderer(){const{loaded:e,symbolizer:t,renderer:i}=this;if(!e||!t||!i)return;const{rasterInfo:n}=this.raster,r=(0,S.ct)(n,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),s=null===r||void 0===r?void 0:r.name,o=(0,M.m7)(n,s);return this._updateSymbolizer(t,i,s,o)}async applyRenderer(e,t,i){var n;const r=null===e||void 0===e?void 0:e.pixelBlock;if(!(null!=r&&r.pixels&&r.pixels.length>0))return null;await this.updateRenderer();const s=null!==(n=this.bandIds)&&void 0!==n?n:[],{pixelBlock:o}=await this._symbolize({pixelData:e,simpleStretchParams:t,bandIds:s,symbolizer:this.symbolizer},i);return o}getRawDisplayBandIds(){let{bandIds:e,raster:t}=this;if(this.rasterFunction&&(0,b.qg)(t)){var i;const n=t.rasterFunction.rawInputBandIds;e=null!==(i=e)&&void 0!==i&&i.length&&null!==n&&void 0!==n&&n.length&&1!==t.rasterInfo.bandCount?e.map(e=>n[Math.min(e,n.length-1)]):n}return e&&e.length>3&&e.every((e,t)=>e===t)?null:e}getTileUrl(e,t,i){return"RasterTileServer"===this.raster.datasetFormat?"".concat(this.url,"/tile/").concat(e,"/").concat(t,"/").concat(i):""}getCompatibleTileInfo(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.loaded||null==t)return null;if(i&&e.equals(this.spatialReference))return this.tileInfo;const n=(0,p.Vp)(e);return R.A.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}getCompatibleFullExtent(e){var t;return this.loaded?(null!==(t=this._compatibleFullExtent)&&void 0!==t&&t.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}async fetchTile(e,t,i){var r;let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(J(this),o.requestAsImageElement){const r=this.getTileUrl(e,t,i);return(0,s.A)(r,{responseType:"image",query:(0,n.A)((0,n.A)({},this.refreshParameters),this.raster.ioConfig.customFetchParameters),signal:o.signal}).then(e=>e.data)}const{serviceRasterInfo:l}=this;if(null!=l.multidimensionalInfo&&null==(o=this.normalizeRasterFetchOptions(o)).multidimensionalDefinition){const n=o.tileInfo||l.storageInfo.tileInfo,r=this.raster.getTileExtentFromTileInfo(e,t,i,n);if(r)return{extent:r,pixelBlock:null}}return await this._initJobHandler(),await this.updateRasterFunction(),"raster-shaded-relief"===(null===(r=this.renderer)||void 0===r?void 0:r.type)&&(o=(0,n.A)((0,n.A)({},o),{},{buffer:{cols:1,rows:1}})),this.raster.fetchTile(e,t,i,o)}async fetchPixels(e,t,i){var n,r;let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(null!=this.serviceRasterInfo.multidimensionalInfo&&null==(s=this.normalizeRasterFetchOptions(s)).multidimensionalDefinition)return{extent:e,pixelBlock:null};await this._initJobHandler(),await this.updateRasterFunction(),t=Math.round(t),i=Math.round(i);const o=await this.raster.fetchPixels(e,t,i,s);return null!==(n=s.bandIds)&&void 0!==n&&n.length&&!this.raster.rasterInfo.storageInfo.isBsqTile&&(o.pixelBlock=null===(r=o.pixelBlock)||void 0===r?void 0:r.extractBands(s.bandIds)),o}async getSamples(e,t){var i;if(await this.load(),(e=(0,c.PZ)(z.A,e).clone()).interpolation&&"nearest"!==e.interpolation)throw new o.A("imagery-tile-mixin:get-samples","only nearest interpolation is currently supported");const r=null===(i=e.mosaicRule)||void 0===i?void 0:i.multidimensionalDefinition,s=(0,n.A)((0,n.A)({},t),{},{multidimensionalDefinition:r}),l=(await this._getSampleLocations(e)).map(e=>this.identify(e,s).then(t=>(t.location=e,t))),a=(await Promise.all(l)).flatMap((e,t)=>this._convertRasterIdentifyResultToSample(e,t));return new N.A({samples:a})}async identify(e){var t,i;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};await this.load(),e=(0,c.PZ)(m.A,e).clone().normalize();const{raster:s,serviceRasterInfo:l}=this;if(null!=(null===l||void 0===l?void 0:l.multidimensionalInfo)&&(!l.hasMultidimensionalTranspose||!(0,S.DY)(r.multidimensionalDefinition)&&!r.transposedVariableName)&&null==(r=this.normalizeRasterFetchOptions(r)).multidimensionalDefinition)return{location:e,value:null};const a=null===(t=this.multidimensionalSubset)||void 0===t?void 0:t.areaOfInterest;if(a&&!a.contains(e))throw new o.A("imagery-tile-mixin:identify","the request cannot be fulfilled when falling outside of the multidimensional subset");let u;if(null!==(i=this.serviceRasterInfo)&&void 0!==i&&i.storageInfo.isBsqTile){const e=(0,b.qg)(s)?this.getRawDisplayBandIds():this.bandIds;u=null!==e&&void 0!==e&&e.length?e:void 0}return s.identify(e,(0,n.A)((0,n.A)({},r),{},{bandIds:u}))}hasStandardTime(){var e,t,i;const n=null===(e=this.serviceRasterInfo)||void 0===e?void 0:e.multidimensionalInfo;if(null==n||"standard-time"!==(null===(t=this.serviceRasterInfo)||void 0===t?void 0:t.dataType))return!1;const r=this.multidimensionalDefinition,s=null===r||void 0===r||null===(i=r[0])||void 0===i?void 0:i.variableName;return n.variables.some(e=>e.name===s&&(!(null!==r&&void 0!==r&&r[0].dimensionName)||e.dimensions.some(e=>"StdTime"===e.name)))}getStandardTimeValue(e){return new Date((0,S.$E)(e)).toISOString()}getMultidimensionalSubsetVariables(e){var t;const i=null!==e&&void 0!==e?e:null===(t=this.serviceRasterInfo)||void 0===t?void 0:t.multidimensionalInfo;return(0,S.z2)(this.multidimensionalSubset,i)}_configDefaultSettings(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=(0,S.fy)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this.rasterFunction&&(0,b.qg)(this.raster)&&(this._cachedRasterFunctionJson=this.rasterFunction.toJSON()),this._configDefaultRenderer()}async _initJobHandler(){if(!this._rasterJobHandler)return super._initJobHandler().then(async()=>{if(!this._rasterJobHandler)return;J(this);const{raster:e}=this;e.rasterJobHandler=this._rasterJobHandler,(0,b.qg)(e)&&e.syncJobHandler(),this.rasterFunction&&await this.updateRasterFunction().catch(()=>{}),this.renderer&&this.updateRenderer()}).catch(()=>{})}_shutdownJobHandler(){super._shutdownJobHandler(),this.raster&&(this.raster.rasterJobHandler=null)}async _getSampleLocations(e){const{geometry:t}=e;if("point"===t.type)return[t];const{spatialReference:n,type:r}=t;if("multipoint"===r)return t.points.map(e=>new m.A({x:e[0],y:e[1],spatialReference:n}));if("polyline"===r){let r=t;if(e.sampleCount||e.sampleDistance){const n=await Promise.all([i.e(6871),i.e(6364),i.e(6175),i.e(426),i.e(8609)]).then(i.bind(i,8609)),s=(await Promise.all([i.e(6871),i.e(6364),i.e(6175),i.e(426),i.e(5661)]).then(i.bind(i,89227))).execute(t,{unit:"meters"}),o=Math.min(e.sampleCount||100,1e3);let l=e.sampleDistance;l||(l=s/(o+(2===r.paths[0].length?1:0))),r=n.execute(t,l,{unit:"meters"})}return r.paths.flatMap(e=>e.map(e=>new m.A({x:e[0],y:e[1],spatialReference:n})))}const s=Math.min(e.sampleCount||100,1e3),o="extent"===t.type,l=o?t:t.extent,a=Math.sqrt(l.width*l.height/s),c=l.height/a,u=l.width/a,{xmin:h,ymax:d}=l,f=[];for(let i=0;i<c;i++)for(let e=0;e<u;e++){const r=new m.A({x:h+(e+.5)*a,y:d-(i+.5)*a,spatialReference:n});(o||t.contains(r))&&f.push(r)}return f}_configDefaultInterpolation(){if(null==this.interpolation){var e;J(this);const{raster:t}=this,i=(0,M.w6)(t.rasterInfo,t.tileType,null===(e=this.sourceJSON)||void 0===e?void 0:e.defaultResamplingMethod);this._set("interpolation",i)}}_configDefaultRenderer(){var e,t;let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"no";J(this);const{rasterInfo:r}=this.raster,s=(0,S.ct)(r,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),o=null===s||void 0===s?void 0:s.name,a=(0,M.I8)({variableName:o,rasterFunctionName:null===(e=this.rasterFunction)||void 0===e?void 0:e.functionName,presetRenderers:this.presetRenderers});if(!this.bandIds&&r.bandCount>1&&(this.bandIds=null!==(t=null===a||void 0===a?void 0:a.bandIds)&&void 0!==t?t:(0,M.ci)(r)),!this.renderer||"override"===i){var c,u,h;const e=(0,M.Mm)(this.raster),t=null!==(c=null===a||void 0===a?void 0:a.renderer)&&void 0!==c?c:(0,M.PD)(r,{bandIds:this.bandIds,variableName:o,rasterFunctionColorRamp:e}),i=r.statistics,n=i&&i.length>0?i[0]:null,s=null!==(u=null===n||void 0===n?void 0:n.max)&&void 0!==u?u:0,l=null!==(h=null===n||void 0===n?void 0:n.min)&&void 0!==h?h:0;"WCSServer"===this.raster.datasetFormat&&"raster-stretch"===t.type&&(s>1e24||l<-1e24)&&(t.dynamicRangeAdjustment=!0,t.customStatistics=null,"none"===t.stretchType&&(t.stretchType="min-max")),this.renderer=t}const d=(0,M.$P)((0,n.A)((0,n.A)({},this.renderer.toJSON()),{},{variableName:o})),m=(0,M.m7)(r,o);this.symbolizer?(this.symbolizer.rendererJSON=d,this.symbolizer.rasterInfo=m):this.symbolizer=new P.A({rendererJSON:d,rasterInfo:m});const f=this.symbolizer.bind();if(f.success){if("auto"===i){const{colormap:e}=this.raster.rasterInfo,t=this.renderer;if(null!=e&&"raster-colormap"===t.type){const e=(0,M.PD)(this.raster.rasterInfo);JSON.stringify(e)!==JSON.stringify(t)&&this._configDefaultRenderer("override")}else if("raster-stretch"===t.type){var p,g;const e=null===(p=this.bandIds)||void 0===p?void 0:p.length,i=null===(g=t.customStatistics)||void 0===g?void 0:g.length;!t.dynamicRangeAdjustment&&i&&e&&i!==e&&this._configDefaultRenderer("override")}}}else l.A.getLogger(this).warn("imagery-tile-mixin",f.error||"The given renderer is not supported by the layer."),"auto"===i&&this._configDefaultRenderer("override")}async _updateRasterFunction(){if(this._isConstructedFromFunctionRaster&&(0,b.qg)(this.raster)){const e=this.raster.rasterFunction.toJSON();return void(!this.rasterFunction&&e&&this._set("rasterFunction",_.A.fromJSON(e)))}let e,t=this.raster,i=!1;(0,b.qg)(t)?(e=t.primaryRasters.rasters,t=e[0],i=!0):e=[t];const{rasterFunction:n}=this;if(n){var r,s;const i={raster:t};e.length>1&&e.forEach(e=>i[e.url]=e);const o=(0,k.vt)(null!==(r=null===(s=n.functionDefinition)||void 0===s?void 0:s.toJSON())&&void 0!==r?r:n.toJSON(),i),l=new w.A({rasterFunction:o});l.rasterJobHandler=this._rasterJobHandler,await l.open(),this.raster=l}else this.raster=t,await t.open();if(this._cachedRendererJson=void 0,!i&&!n)return;const{bandIds:o}=this,{bandCount:l}=this.raster.rasterInfo,a=null!==o&&void 0!==o&&o.length?o.some(e=>e>=l):l>=3;o&&(a||this.renderer&&"raster-stretch"!==this.renderer.type)&&this._set("bandIds",null),this._configDefaultRenderer("auto")}_convertRasterIdentifyResultToSample(e,t){var i,n;const{rasterInfo:r}=this.raster,s=r.storageInfo.pyramidScalingFactor**(null!==(i=e.pyramidLevel)&&void 0!==i?i:0),o=(r.pixelSize.x+r.pixelSize.y)/2*s;if(null===(n=e.dataSeries)||void 0===n||!n.length)return[new D.A({location:e.location,pixelValue:e.value,locationId:t,resolution:o})];const l=[];return e.dataSeries.forEach((i,n)=>{let{value:r,multidimensionalDefinition:s}=i;const a={Variables:s[0].variableName,Dimensions:s.flatMap(e=>{let{dimensionName:t}=e;return t}).join(",")};for(const{dimensionName:e,values:t}of s){a[e]=Array.isArray(t[0])?t[0][0]:t[0];const i=t[t.length-1];a["".concat(e,"_Max")]=Array.isArray(i)?i[i.length-1]:i}const c=new D.A({location:e.location,pixelValue:r,rasterId:n,locationId:t,resolution:o,attributes:a});l.push(c)}),l}};function J(e){if(!e.raster||!e.serviceRasterInfo)throw new o.A("imagery-tile","no raster")}return(0,r.Cg)([(0,a.MZ)({clonable:!1})],H.prototype,"_cachedRasterFunctionJson",void 0),(0,r.Cg)([(0,a.MZ)({clonable:!1})],H.prototype,"_compatibleFullExtent",void 0),(0,r.Cg)([(0,a.MZ)({clonable:!1})],H.prototype,"_isConstructedFromFunctionRaster",void 0),(0,r.Cg)([(0,a.MZ)({clonable:!1})],H.prototype,"_rasterFunctionUpdatePromise",void 0),(0,r.Cg)([(0,a.MZ)({type:[c.jz],json:{write:{overridePolicy(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null===(e=this.bandIds)||void 0===e?void 0:e.join(","))}}}}})],H.prototype,"bandIds",void 0),(0,r.Cg)([(0,a.MZ)({json:{origins:{service:{read:{source:"copyrightText"}}}}})],H.prototype,"copyright",void 0),(0,r.Cg)([(0,a.MZ)({json:{read:!1}})],H.prototype,"fullExtent",null),(0,r.Cg)([(0,a.MZ)({json:{write:{overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),(0,u.e)(I.SZ)],H.prototype,"interpolation",void 0),(0,r.Cg)([(0,a.MZ)()],H.prototype,"ioConfig",void 0),(0,r.Cg)([(0,a.MZ)({type:[v.A],json:{write:!0}})],H.prototype,"multidimensionalDefinition",null),(0,r.Cg)([(0,a.MZ)({type:x.A,json:{write:!0}})],H.prototype,"multidimensionalSubset",void 0),(0,r.Cg)([(0,a.MZ)()],H.prototype,"raster",void 0),(0,r.Cg)([(0,a.MZ)({type:_.A})],H.prototype,"rasterFunction",null),(0,r.Cg)([(0,a.MZ)()],H.prototype,"serviceRasterInfo",void 0),(0,r.Cg)([(0,a.MZ)()],H.prototype,"sourceJSON",void 0),(0,r.Cg)([(0,a.MZ)({readOnly:!0,type:f.A,json:{read:!1}})],H.prototype,"spatialReference",void 0),(0,r.Cg)([(0,a.MZ)({type:R.A})],H.prototype,"tileInfo",void 0),(0,r.Cg)([(0,a.MZ)(y.OZ)],H.prototype,"url",null),(0,r.Cg)([(0,a.MZ)()],H.prototype,"renderer",null),(0,r.Cg)([(0,a.MZ)({types:F.uy,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy(){var e;const t="raster-stretch"===(null===(e=this.renderer)||void 0===e?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:F.Gj,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:e=>({enabled:e&&"vector-field"!==e.type})}}}}})],H.prototype,"internalRenderer",null),(0,r.Cg)([(0,h.w)("internalRenderer")],H.prototype,"readRenderer",null),(0,r.Cg)([(0,a.MZ)({clonable:!1})],H.prototype,"symbolizer",void 0),H=(0,r.Cg)([(0,d.$)("esri.layers.mixins.ImageryTileMixin")],H),H}},34429:(e,t,i)=>{i.d(t,{QueueProcessor:()=>u});var n=i(30726),r=i(50346),s=i(59649),o=i(67993),l=i(52394),a=i(75540);class c{constructor(e,t){this.item=e,this.controller=t,this.promise=null}}class u{constructor(e){this._schedule=null,this._deferreds=new o.A,this._controllers=new o.A,this._processingItems=new o.A,this._pausedSignal=(0,a.v)(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new s.A(e.peeker),this.process=e.process}destroy(){this.clear(),this._schedule=(0,n.xt)(this._schedule)}get updating(){return this.running}get length(){return this._processingItems.size+this._queue.length}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(t=>e.push(t)),this._controllers.clear(),e.forEach(e=>e.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((t,i)=>e(i))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,t){const i=this.get(e);if(i)return i;const n=new AbortController;let s=null;t&&(s=(0,r.u7)(t,()=>n.abort()));const o=()=>{l.remove(),null!=s&&s.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},l=(0,r.NY)(n.signal,()=>{const t=this._processingItems.get(e);t&&t.controller.abort(),o(),a.reject((0,r.NK)())}),a=(0,r.Tw)();return this._deferreds.set(e,a),this._controllers.set(e,n),a.promise.then(o,o),this._queue.push(e),this._scheduleNext(),a.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){var e;const t=this._queue.popLast();return t&&(null!==(e=this._deferreds.get(t))&&void 0!==e&&e.reject((0,r.NK)()),this._removeItem(t)),t}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._pausedSignal.value||this._schedule||(this._schedule=(0,l._)(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(null==e)return;let t;const i=new AbortController,n=new c(e,i);this._processingItems.set(e,n);try{t=this.process(e,i.signal)}catch(s){this._processError(n,s)}(0,r.$X)(t)?(n.promise=t,t.then(e=>this._processResult(n,e),e=>this._processError(n,e))):this._processResult(n,t)}}},85396:(e,t,i)=>{i.d(t,{A:()=>H});var n=i(89379),r=i(6326),s=i(3825),o=i(50076),l=i(42553),a=i(76460),c=i(50346),u=i(34429),h=i(46053),d=i(40565),m=(i(81806),i(47249),i(87990)),f=i(76797),p=i(19247),g=i(13312),y=i(13096),v=i(95363),x=i(15359),I=i(22848),_=i(49653),R=i(88235),b=i(17775),w=i(68347);var S=i(59844);const A=new Map,k=new class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15e3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=e,this._interval=Math.min(e,t)}decreaseRefCount(e,t){const i=e+"/"+t,n=this._cachedBlocks;if(n.has(i)){const e=n.get(i);return e.refCount--,e.refCount<=0&&(n.delete(i),e.controller&&e.controller.abort()),e.refCount}return 0}getBlock(e,t){const i=e+"/"+t,n=this._cachedBlocks;if(n.has(i)){const e=n.get(i);return e.ts=Date.now(),e.refCount++,n.delete(i),n.set(i,e),e.block}return null}putBlock(e,t,i,n){const r=this._cachedBlocks,s=e+"/"+t;if(r.has(s)){const e=r.get(s);e.ts=Date.now(),e.refCount++}else r.set(s,{block:i,ts:Date.now(),refCount:1,controller:n});this._trim(),this._updateTimer()}deleteBlock(e,t){const i=this._cachedBlocks,n=e+"/"+t;i.has(n)&&i.delete(n)}updateMaxSize(e){this._size=e,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const e=this._cachedBlocks;this._timer=setInterval(()=>{const t=Array.from(e),i=Date.now();for(let n=0;n<t.length&&t[n][1].ts<=i-this._duration;n++)e.delete(t[n][0]);0===e.size&&this._clearTimer()},this._interval)}_trim(){const e=this._cachedBlocks;if(-1===this._size||this._size>=e.size)return;const t=Array.from(e);for(let i=0;i<t.length-this._size;i++)e.delete(t[i][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}};function C(e,t,i){var n;const r=A.get(e);if(!r)return null==t?k.decreaseRefCount(e,i):0;if(null==t||null==r[t])return k.decreaseRefCount(e,i);const s=null===(n=r[t])||void 0===n?void 0:n.cache,o=null===s||void 0===s?void 0:s.get(i);if(s&&o){if(o.refCount--,0===o.refCount){s.delete(i);for(let e=0;e<r.length;e++){var l;null===(l=r[e])||void 0===l||l.cache.delete(i)}o.controller&&o.controller.abort()}return o.refCount}return 0}function T(e,t,i){var n;const r=A.get(e);if(!r)return null==t?k.getBlock(e,i):null;if(null==t||null==r[t]){for(let e=0;e<r.length;e++){var s;const t=null===(s=r[e])||void 0===s?void 0:s.cache.get(i);if(t)return t.refCount++,t.block}return k.getBlock(e,i)}const o=null===(n=r[t])||void 0===n?void 0:n.cache.get(i);if(o)return o.refCount++,o.block;for(let a=0;a<r.length;a++){var l;if(a===t||!r[a])continue;const e=null===(l=r[a])||void 0===l?void 0:l.cache,n=null===e||void 0===e?void 0:e.get(i);if(e&&n)return n.refCount++,e.set(i,n),n.block}return null}function M(e,t,i,n){var r;let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;const o=A.get(e);if(!o)return void(null==t&&k.putBlock(e,i,n,s));if(null==t||null==o[t])return void k.putBlock(e,i,n,s);const l={refCount:1,block:n,isResolved:!1,isRejected:!1,controller:s};n.then(()=>l.isResolved=!0).catch(()=>l.isRejected=!0),null===(r=o[t])||void 0===r||r.cache.set(i,l)}function P(e,t,i){var n;const r=A.get(e);r?null!=t&&null!=r[t]?null===(n=r[t])||void 0===n||n.cache.delete(i):k.deleteBlock(e,i):null==t&&k.deleteBlock(e,i)}var F=i(52297),B=i(93982),D=i(52494),z=i(99846);let N=0,H=class extends l.o{constructor(){super(...arguments),this._tileFetchQueue=new u.QueueProcessor({concurrency:32,process:(e,t)=>this._fetchRawTile(e.pyramidLevel,e.row,e.col,(0,n.A)((0,n.A)({},e.options),{},{signal:t}))}),this.datasetName=null,this.datasetFormat=null,this.hasUniqueSourceStorageInfo=!0,this.rasterInfo=null,this.ioConfig={sampling:"closest"}}normalizeCtorArgs(e){var t;return null!==(t=e)&&void 0!==t&&t.ioConfig&&(e=(0,n.A)((0,n.A)({},e),{},{ioConfig:(0,n.A)({resolution:null,bandIds:null,sampling:"closest",tileInfo:R.A.create()},e.ioConfig)})),e}get _isGlobalWrappableSource(){const{rasterInfo:e}=this,t=(0,S.FT)(e.spatialReference);return null!=t&&e.extent.width>=t/2}get _hasNoneOrGCSShiftTransform(){const{transform:e}=this.rasterInfo;return null==e||"gcs-shift"===e.type}set rasterJobHandler(e){var t;this._set("rasterJobHandler",e),(0,b.qg)(this)&&(null===(t=this.primaryRasters)||void 0===t||null===(t=t.rasters)||void 0===t||t.forEach(t=>t.rasterJobHandler=e))}get rasterId(){return this.url||"rasterId-"+N++}set url(e){this._set("url",(0,y.Jf)(e,a.A.getLogger(this)))}async open(e){var t;return null!==(t=this._openPromise)&&void 0!==t||(this._openPromise=(0,S.Hh)().then(()=>this._open(e))),this._openPromise}async fetchTile(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const s=r.tileInfo||this.rasterInfo.storageInfo.tileInfo,l=this.getTileExtentFromTileInfo(e,t,i,s);if(!l)throw new o.A("imagery-tile:out-of-bounds","Level for fetch tile out of range");return r=(0,n.A)({noClip:!0},r),this.fetchPixels(l,s.size[0],s.size[1],r)}async identify(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=(0,d.PZ)(p.A,e).clone().normalize();const{multidimensionalDefinition:r,timeExtent:s}=i,{rasterInfo:o}=this,{hasMultidimensionalTranspose:l,multidimensionalInfo:a}=o;let{transposedVariableName:c}=i;const u=null!=a&&l&&(null!=s||(0,w.DY)(r));var h;u&&!c&&(c=null!=r&&r.length>0?null!==(h=r[0].variableName)&&void 0!==h?h:void 0:a.variables[0].name,i=(0,n.A)((0,n.A)({},i),{},{transposedVariableName:c}));i=this._getRequestOptionsWithSliceId(i);const{spatialReference:m,extent:g}=o,{datumTransformation:y}=i;let v=(0,S._I)(e,m,y);if(!g.intersects(v))return{location:v,value:null};if(null!=o.transform){const e=o.transform.inverseTransform(v);if(!o.nativeExtent.intersects(e))return{location:e,value:null};v=e}let x=0;const I=null!=c&&null!=a&&o.hasMultidimensionalTranspose;if((0,b.qg)(this)){const e=this.primaryRasters.rasters[0];if(I)return e.identify(v,i);const{pixelSize:t}=o,n=3,s=t.x*n/2,l=t.y*n/2,a=new f.A({xmin:v.x-s,xmax:v.x+s,ymin:v.y-l,ymax:v.y+l,spatialReference:m}),c={interpolation:"nearest",multidimensionalDefinition:r,sliceId:i.sliceId,bandIds:i.bandIds},{pixelBlock:u}=await e.fetchPixels(a,n,n,c),{pixelBlock:h}=await this.fetchPixels(a,n,n,c);if(null==u)return{location:v,value:null};const d=Math.floor(n*n*.5),p=!u.mask||u.mask[d]?u.pixels.map(e=>e[d]):null;let g;return null!=h&&(g=!h.mask||h.mask[d]?h.pixels.map(e=>e[d]):void 0),{location:v,value:p,processedValue:g,pyramidLevel:0}}if(!I)if(i.srcResolution)x=(0,S.t$)(i.srcResolution,o,this.ioConfig.sampling).pyramidLevel;else if(x=await this.computeBestPyramidLevelForLocation(e,i),null==x)return{location:v,value:null};const _=this.identifyPixelLocation(v,x,null,I);if(null===_)return{location:v,value:null};const{row:R,col:A,rowOffset:k,colOffset:C,blockWidth:T}=_,M=await this._tileFetchQueue.push({pyramidLevel:x,row:R,col:A,options:i},{signal:i.signal});if(null===M||void 0===M||null===(t=M.pixels)||void 0===t||!t.length)return{location:v,value:null};const P=k*T+C;return this._processIdentifyResult(M,{srcLocation:v,position:P,pyramidLevel:x,useTransposedTile:!!I,requestSomeSlices:u,identifyOptions:i})}async fetchPixels(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};e=(0,S.Ps)(e),n=this._getRequestOptionsWithSliceId(n);const{_hasNoneOrGCSShiftTransform:r}=this;if(n.requestRawData&&r)return this._fetchPixels(e,t,i,n);const s=(0,S.FT)(e.spatialReference),o=(0,S.OM)(e);if(null==s||0===o||1===o&&this._isGlobalWrappableSource&&r)return this._fetchPixels(e,t,i,n);if(o>=3)return{extent:e,pixelBlock:null};const l=[],{xmin:a,xmax:c}=e,u=Math.round(s/(c-a)*t),h=u-Math.round((s/2-a)/(c-a)*t);let d=0;const m=[];for(let v=0;v<=o;v++){const r=new f.A({xmin:0===v?a:-s/2,xmax:v===o?c-s*v:s/2,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference}),p=0===v?u-h:v===o?t-d:u;d+=p,m.push(p);const g=n.disableWrapAround&&v>0?null:this._fetchPixels(r,p,i,n);l.push(g)}const p=(await Promise.all(l)).map(e=>null===e||void 0===e?void 0:e.pixelBlock);let g=null;const y={width:t,height:i};return g=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:p,srcMosaicSize:y,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:m},n)).pixelBlock:(0,D.z7)(p,y,{blockWidths:m}),{extent:e,srcExtent:(0,S._l)(e,this.rasterInfo.spatialReference,n.datumTransformation),pixelBlock:g}}async fetchRawPixels(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};t={x:Math.floor(t.x),y:Math.floor(t.y)};const r=await this._fetchRawTiles(e,t,i,n),{nativeExtent:s,nativePixelSize:o,storageInfo:l}=this.rasterInfo,a=2**e,c=o.x*a,u=o.y*a,h=new f.A({xmin:s.xmin+c*t.x,xmax:s.xmin+c*(t.x+i.width-1),ymin:s.ymax-u*(t.y+i.height-1),ymax:s.ymax-u*t.y,spatialReference:s.spatialReference});if(!r)return{extent:h,srcExtent:h,pixelBlock:null};const{pixelBlocks:d,mosaicSize:m}=r;if(1===d.length&&null!=d[0]&&d[0].width===i.width&&d[0].height===i.height)return{extent:h,srcExtent:h,pixelBlock:r.pixelBlocks[0]};const p=e>0?l.pyramidBlockWidth:l.blockWidth,g=e>0?l.pyramidBlockHeight:l.blockHeight,y={x:t.x%p,y:t.y%g};let v;return v=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:d,srcMosaicSize:m,destDimension:i,clipOffset:y,clipSize:i,coefs:null,sampleSpacing:null,interpolation:n.interpolation,alignmentInfo:null,blockWidths:null},n)).pixelBlock:(0,D.z7)(d,m,{clipOffset:y,clipSize:i}),{extent:h,srcExtent:h,pixelBlock:v}}fetchRawTile(e,t,i,n){throw new o.A("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}computeExtent(e){return(0,S._l)(this.rasterInfo.extent,e)}decodePixelBlock(e,t){return!this.rasterJobHandler||t.useCanvas?(0,B.D)(e,t):this.rasterJobHandler.decode({data:e,options:t})}async request(e,t){var i;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const{customFetchParameters:o}=this.ioConfig,{range:l,query:a,headers:c}=t;r=null!==(i=null!==r&&void 0!==r?r:t.retryCount)&&void 0!==i?i:this.ioConfig.retryCount;const u=l?{Range:"bytes=".concat(l.from,"-").concat(l.to)}:null;try{return await(0,s.A)(e,(0,n.A)((0,n.A)({},t),{},{query:(0,n.A)((0,n.A)({},a),o),headers:(0,n.A)((0,n.A)({},c),u)}))}catch(k){if(r>0)return r--,this.request(e,t,r);throw k}}getSliceIndex(e){const{multidimensionalInfo:t}=this.rasterInfo;return null==t||null==e||0===e.length?null:(0,w.NG)(e,t)}getTileExtentFromTileInfo(e,t,i,n){const r=n.lodAt(e);return r?this.getTileExtent({x:r.resolution,y:r.resolution},t,i,n.origin,n.spatialReference,n.size):null}updateTileInfo(){const{storageInfo:e,spatialReference:t,extent:i,pixelSize:n}=this.rasterInfo,{pyramidResolutions:r}=e;if(!e.tileInfo){const s=[],o=e.maximumPyramidLevel||0;let l=(n.x+n.y)/2,a=1/.0254*96*l;for(let e=0;e<=o&&(s.unshift(new I.A({level:o-e,resolution:l,scale:a})),e!==o);e++)if(r){const t=(r[e].x+r[e].y)/2;a*=t/l,l=t}else l*=2,a*=2;const c=new p.A({x:i.xmin,y:i.ymax,spatialReference:t});e.tileInfo=new R.A({origin:c,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:s}),e.isVirtualTileInfo=!0}}createRemoteDatasetStorageInfo(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=arguments.length>3?arguments[3]:void 0;const{width:r,height:s,nativeExtent:o,pixelSize:l,spatialReference:a}=e,c=new p.A({x:o.xmin,y:o.ymax,spatialReference:a});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(r,s))/Math.LN2-8)));const u=this.computeBlockBoundary(o,512,512,{x:o.xmin,y:o.ymax},[l],n);e.storageInfo=new _.A({blockWidth:t,blockHeight:i,pyramidBlockWidth:t,pyramidBlockHeight:i,origin:c,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:u})}async computeBestPyramidLevelForLocation(e){return 0}computeBlockBoundary(e,t,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:2;if(1===r.length&&s>0){r=[...r];let{x:e,y:t}=r[0];for(let i=0;i<s;i++)e*=o,t*=o,r.push({x:e,y:t})}const l=[],{x:a,y:c}=n;for(let u=0;u<r.length;u++){const{x:n,y:s}=r[u];l.push({minCol:Math.floor((e.xmin-a+.1*n)/t/n),maxCol:Math.floor((e.xmax-a-.1*n)/t/n),minRow:Math.floor((c-e.ymax+.1*s)/i/s),maxRow:Math.floor((c-e.ymin-.1*s)/i/s)})}return l}getPyramidPixelSize(e){const{nativePixelSize:t}=this.rasterInfo,{pyramidResolutions:i,pyramidScalingFactor:n}=this.rasterInfo.storageInfo;if(0===e)return t;if(null!=i&&i.length)return i[e-1];const r=n**e;return{x:t.x*r,y:t.y*r}}identifyPixelLocation(e,t,i,n){const{spatialReference:r,nativeExtent:s,storageInfo:o}=this.rasterInfo,{maximumPyramidLevel:l,origin:a,transposeInfo:c}=o,u=n&&null!=c?c.tileSize[0]:o.blockWidth,h=n&&null!=c?c.tileSize[1]:o.blockHeight,d=(0,S._I)(e,r,i);if(!s.intersects(d))return null;if(t<0||t>l)return null;const m=this.getPyramidPixelSize(t),{x:f,y:p}=m,g=(a.y-d.y)/p/h,y=(d.x-a.x)/f/u,v=Math.min(h-1,Math.floor((g-Math.floor(g))*h)),x=Math.min(u-1,Math.floor((y-Math.floor(y))*u));return{pyramidLevel:t,row:Math.floor(g),col:Math.floor(y),rowOffset:v,colOffset:x,blockWidth:u,srcLocation:d}}getTileExtent(e,t,i,n,r,s){const[o,l]=s,a=n.x+i*o*e.x,c=a+o*e.x,u=n.y-t*l*e.y,h=u-l*e.y;return new f.A({xmin:a,xmax:c,ymin:h,ymax:u,spatialReference:r})}getBlockWidthHeight(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}isBlockOutside(e,t,i){const n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<i||n.minRow>t||n.minCol>i}updateImageSpaceRasterInfo(e){const{pixelSize:t}=e,{width:i,height:n}=e,r=g.A.WebMercator;e.spatialReference=r,e.extent=e.nativeExtent=new f.A({xmin:-.5,ymax:.5,xmax:i-.5,ymin:.5-n,spatialReference:r}),e.isPseudoSpatialReference=!0,e.transform=null,e.pixelSize=new p.A({x:1,y:1,spatialReference:r});const{extent:s,storageInfo:o}=e;if(o){o.origin=new p.A({x:s.xmin,y:s.ymax,spatialReference:r});const{pyramidResolutions:i,tileInfo:n}=o;if(i&&i.forEach(e=>{e.x/=t.x,e.y/=t.y}),n){n.origin=o.origin;const t=(e.nativePixelSize.x+e.nativePixelSize.y)/2;n.lods.forEach((e,i)=>{e.resolution=t*2**i,e.scale=96*e.resolution/.0254})}}}async _fetchPixels(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=(0,S.OM)(e);if(r>=2)return{extent:e,pixelBlock:null};const s=this._getSourceDataInfo(e,t,i,n),{pyramidLevel:o,srcResolution:l,srcExtent:a,srcWidth:c,srcHeight:u,ul:h}=s;if(0===c||0===u)return{extent:e,srcExtent:a,pixelBlock:null};const{rasterInfo:d}=this,m=d.transform,f="gcs-shift"===(null===m||void 0===m?void 0:m.type),g=null!=(0,S.FT)(e.spatialReference);!f&&g||(r=(0,S.OM)(s.srcExtent,f));const y=await this._fetchRawTiles(o,h,{width:c,height:u,wrapCount:r},n);if(!y)return{extent:e,srcExtent:a,pixelBlock:null};const v=d.storageInfo,x=o>0?v.pyramidBlockWidth:v.blockWidth,I=o>0?v.pyramidBlockHeight:v.blockHeight;let{x:_,y:R}=d.pixelSize;if(o>0){const{pyramidResolutions:e,pyramidScalingFactor:t}=v;if(null!=e&&e[o-1])({x:_,y:R}=e[o-1]);else{const e=t**o;_*=e,R*=e}}const b=d.spatialReference,w=new p.A({x:_,y:R,spatialReference:b}),A=x===c&&I===u&&h.x%x===0&&h.y%I===0,k=new p.A({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/i,spatialReference:e.spatialReference}),C=!e.spatialReference.equals(b),T=b.isGeographic?1e-9:1e-4,{datumTransformation:M}=n;if(!C&&A&&1===y.pixelBlocks.length&&x===t&&I===i&&function(e,t,i){return Math.abs(e.x-t.x)<i&&Math.abs(e.y-t.y)<i}(l,k,T))return{extent:e,srcExtent:a,srcTilePixelSize:w,pixelBlock:y.pixelBlocks[0]};const P=g&&null!=(0,S.FT)(a.spatialReference)&&this._hasNoneOrGCSShiftTransform,F=n.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector");F&&!this.rasterJobHandler&&await(0,S.Hh)();const B=this.rasterJobHandler?await this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:e,srcBufferExtent:y.extent,pixelSize:k.toJSON(),datumTransformation:M,rasterTransform:m,hasWrapAround:r>0||P,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:F},n):(0,S.l0)({projectedExtent:e,srcBufferExtent:y.extent,pixelSize:k,datumTransformation:M,rasterTransform:m,hasWrapAround:r>0||P,isAdaptive:!1,includeGCSGrid:F});let N;const H=!n.requestRawData,J={rows:B.spacing[0],cols:B.spacing[1]},O=this._hasNoneOrGCSShiftTransform?this._getRasterTileAlignmentInfo(o,y.extent.xmin):void 0,{pixelBlocks:E,mosaicSize:q,isPartiallyFilled:W}=y;let L=null;if(this.rasterJobHandler){const e=await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:E,srcMosaicSize:q,destDimension:H?{width:t,height:i}:null,coefs:H?B.coefficients:null,sampleSpacing:H?J:null,projectDirections:F,gcsGrid:F?B.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:n.interpolation,alignmentInfo:O,blockWidths:null},n);({pixelBlock:N,localNorthDirections:L}=e)}else{const e=(0,D.z7)(E,q,{alignmentInfo:O});N=H?(0,D.$i)(e,{width:t,height:i},B.coefficients,J,n.interpolation):e,F&&B.gcsGrid&&(L=(0,D.QF)({width:t,height:i},B.gcsGrid),N=(0,z.Y2)(N,this.rasterInfo.dataType,L))}return n.requestRawData||F?{extent:e,srcExtent:a,srcTilePixelSize:w,pixelBlock:N,transformGrid:B,localNorthDirections:L,isPartiallyFilled:W}:{extent:e,srcExtent:a,srcTilePixelSize:w,pixelBlock:N}}async _fetchRawTiles(e,t,i,n){const{origin:r,blockBoundary:s}=this.rasterInfo.storageInfo,{blockWidth:o,blockHeight:l}=this.getBlockWidthHeight(e);let{x:a,y:c}=t,{width:u,height:h,wrapCount:d}=i;const m=this._getRasterTileAlignmentInfo(e,0);n.buffer&&(a-=n.buffer.cols,c-=n.buffer.rows,u+=2*n.buffer.cols,h+=2*n.buffer.rows);let p=0,g=0,y=0;d&&null!=m&&(({worldColumnCountFromOrigin:g,originColumnOffset:y,rightPadding:p}=m),g*m.blockWidth-p>=a+u&&(p=0));const v=Math.floor(a/o),x=Math.floor(c/l),I=Math.floor((a+u+p-1)/o),_=Math.floor((c+h+p-1)/l),R=s[e];if(!R)return null;const{minRow:b,minCol:w,maxCol:S,maxRow:A}=R;if(0===d&&(_<b||I<w||x>A||v>S))return null;const k=new Array;let C=!1;const T=null==this.ioConfig.allowPartialFill?n.allowPartialFill:this.ioConfig.allowPartialFill;for(let f=x;f<=_;f++)for(let t=v;t<=I;t++){let i=t;if(!n.disableWrapAround&&d&&null!=m&&g<=t&&(i=t-g-y),f>=b&&i>=w&&A>=f&&S>=i){const t=this._tileFetchQueue.push({pyramidLevel:e,row:f,col:i,options:n},{signal:n.signal});T?k.push(new Promise(e=>{t.then(t=>e(t)).catch(()=>{C=!0,e(null)})})):k.push(t)}else k.push(Promise.resolve(null))}if(0===k.length)return null;const M=await Promise.all(k),P={height:(_-x+1)*l,width:(I-v+1)*o},{spatialReference:F}=this.rasterInfo,B=this.getPyramidPixelSize(e),{x:D,y:z}=B;return{extent:new f.A({xmin:r.x+v*o*D,xmax:r.x+(I+1)*o*D,ymin:r.y-(_+1)*l*z,ymax:r.y-x*l*z,spatialReference:F}),pixelBlocks:M,mosaicSize:P,isPartiallyFilled:C}}_fetchRawTile(e,t,i,r){const{storageInfo:s}=this.rasterInfo,o=null!=s.transposeInfo&&!!r.transposedVariableName;if(!o){const n=s.blockBoundary[e];if(!n)return Promise.resolve(null);const{minRow:r,minCol:o,maxCol:l,maxRow:a}=n;if(t<r||i<o||t>a||i>l)return Promise.resolve(null)}const l=o?r.transposeVariableName:r.sliceId,a=this.rasterInfo.storageInfo.isBsqTile?r.bandIds:null,u=function(e,t,i){const n=[];return null!=t&&n.push("sliceId=".concat(t)),null!=i&&n.push("bandIds=".concat(i.join(","))),n.length?"".concat(e,"?").concat(n.join("&")):e}(this.rasterId,l,a),h="".concat(e,"/").concat(t,"/").concat(i);let d=T(u,r.registryId,h);if(null==d){const s=new AbortController;d=this.fetchRawTile(e,t,i,(0,n.A)((0,n.A)({},r),{},{signal:s.signal})),M(u,r.registryId,h,d,s),d.catch(()=>P(u,r.registryId,h))}return r.signal&&(0,c.u7)(r,()=>{C(u,r.registryId,h)}),d}_computeMagDirValues(e){var t;const{bandCount:i,dataType:n}=this.rasterInfo;if((2!==i||"vector-magdir"!==n)&&"vector-uv"!==n||2!==(null===e||void 0===e?void 0:e.length)||null===(t=e[0])||void 0===t||!t.length)return null;const r=e[0].length;if("vector-magdir"===n){const t=e[1].map(e=>(e+360)%360);return[e[0],t]}const[s,o]=e,l=[],a=[];for(let c=0;c<r;c++){const[e,t]=(0,z.Lu)([s[c],o[c]]);l.push(e),a.push(t)}return[l,a]}_getRasterTileAlignmentInfo(e,t){return null==this._rasterTileAlignmentInfo&&(this._rasterTileAlignmentInfo=(0,S.DO)(this.rasterInfo)),null==this._rasterTileAlignmentInfo.pyramidsInfo?null:(0,n.A)({startX:t,halfWorldWidth:this._rasterTileAlignmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlignmentInfo.hasGCSSShiftTransform},this._rasterTileAlignmentInfo.pyramidsInfo[e])}_getSourceDataInfo(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const r={datumTransformation:n.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0,ul:{x:0,y:0}};n.srcResolution&&(r.srcResolution=n.srcResolution,this._updateSourceDataInfo(e,r));const s=this.rasterInfo.storageInfo.maximumPyramidLevel||0,{srcWidth:o,srcHeight:l,pyramidLevel:a}=r,c=o/t,u=l/i,h=a<s&&c*u>=16,d=a===s&&this._requireTooManySrcTiles(o,l,t,i);if(h||d||0===o||0===l){const o=new p.A({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/i,spatialReference:e.spatialReference});let l=(0,S.Wo)(o,this.rasterInfo.spatialReference,e,r.datumTransformation);const d=!l||n.srcResolution&&l.x+l.y<n.srcResolution.x+n.srcResolution.y;if(h&&n.srcResolution&&d){const e=Math.round(Math.log(Math.max(c,u))/Math.LN2)-1;if(s-a+3>=e){const t=2**e;l={x:n.srcResolution.x*t,y:n.srcResolution.y*t}}}l&&(r.srcResolution=l,this._updateSourceDataInfo(e,r))}return this._requireTooManySrcTiles(r.srcWidth,r.srcHeight,t,i)&&(r.srcWidth=0,r.srcHeight=0),r}_requireTooManySrcTiles(e,t,i,n){const{tileInfo:r}=this.rasterInfo.storageInfo,s=e/i,o=t/n;return Math.ceil(e/r.size[0])*Math.ceil(t/r.size[1])>=256*Math.max(1,(i+n)/1024)||s>8||o>8}_updateSourceDataInfo(e,t){t.srcWidth=0,t.srcHeight=0;const{rasterInfo:i}=this,n=i.spatialReference,{srcResolution:r,datumTransformation:s}=t,{pyramidLevel:o,pyramidResolution:l,excessiveReading:a}=(0,S.t$)(r,i,this.ioConfig.sampling);if(a)return;let c=t.srcExtent||(0,S._l)(e,n,s);if(null==c)return;const u=i.transform;u&&(c=u.inverseTransform(c)),t.srcExtent=c;const{origin:h}=i.storageInfo,{width:d,height:m,ul:f}=(0,b.$g)(c,h,l,o);t.pyramidLevel=o,t.pyramidResolution=l,t.srcWidth=d,t.srcHeight=m,t.ul=f}_getRequestOptionsWithSliceId(e){return null!=this.rasterInfo.multidimensionalInfo&&null==e.sliceId&&(e=(0,n.A)((0,n.A)({},e),{},{sliceId:this.getSliceIndex(e.multidimensionalDefinition)})),e}_processIdentifyResult(e,t){const{srcLocation:i,position:r,pyramidLevel:s,useTransposedTile:o}=t,l=e.pixels[0].length/e.width/e.height;if(e.mask&&!e.mask[r])return{location:i,value:null};const{multidimensionalInfo:a}=this.rasterInfo;if(null==a||!o){const t=e.pixels.map(e=>e[r]),n={location:i,value:t,pyramidLevel:s},o=this._computeMagDirValues(t.map(e=>[e]));return null!==o&&void 0!==o&&o.length&&(n.magdirValue=o.map(e=>e[0])),n}let c=e.pixels.map(e=>e.slice(r*l,r*l+l)),u=this._computeMagDirValues(c);const{requestSomeSlices:h,identifyOptions:d}=t;let m=(0,w.QW)(a,d.transposedVariableName);if(h){var f;const e=(0,w.xx)(m,d.multidimensionalDefinition,d.timeExtent);c=c.map(t=>e.map(e=>t[e])),u=null===(f=u)||void 0===f?void 0:f.map(t=>e.map(e=>t[e])),m=e.map(e=>m[e])}const p=e.noDataValues||this.rasterInfo.noDataValue,g={pixels:c,pixelType:e.pixelType};let y;return null!=p&&((0,F.Sp)(g,p),y=g.mask),{location:i,value:null,dataSeries:m.map((e,t)=>{var i,r;const s={value:0===(null===(i=y)||void 0===i?void 0:i[t])?null:c.map(e=>e[t]),multidimensionalDefinition:e.multidimensionalDefinition.map(e=>new x.A((0,n.A)((0,n.A)({},e),{},{isSlice:!0})))};return null!==(r=u)&&void 0!==r&&r.length&&(s.magdirValue=[u[0][t],u[1][t]]),s}),pyramidLevel:s}}};(0,r.Cg)([(0,h.MZ)()],H.prototype,"_rasterTileAlignmentInfo",void 0),(0,r.Cg)([(0,h.MZ)()],H.prototype,"_tileFetchQueue",void 0),(0,r.Cg)([(0,h.MZ)({readOnly:!0})],H.prototype,"_isGlobalWrappableSource",null),(0,r.Cg)([(0,h.MZ)({readOnly:!0})],H.prototype,"_hasNoneOrGCSShiftTransform",null),(0,r.Cg)([(0,h.MZ)()],H.prototype,"_openPromise",void 0),(0,r.Cg)([(0,h.MZ)()],H.prototype,"rasterJobHandler",null),(0,r.Cg)([(0,h.MZ)({readOnly:!0})],H.prototype,"rasterId",null),(0,r.Cg)([(0,h.MZ)(v.OZ)],H.prototype,"url",null),(0,r.Cg)([(0,h.MZ)({type:String,json:{write:!0}})],H.prototype,"datasetName",void 0),(0,r.Cg)([(0,h.MZ)({type:String,json:{write:!0}})],H.prototype,"datasetFormat",void 0),(0,r.Cg)([(0,h.MZ)()],H.prototype,"hasUniqueSourceStorageInfo",void 0),(0,r.Cg)([(0,h.MZ)()],H.prototype,"rasterInfo",void 0),(0,r.Cg)([(0,h.MZ)()],H.prototype,"ioConfig",void 0),(0,r.Cg)([(0,h.MZ)()],H.prototype,"sourceJSON",void 0),H=(0,r.Cg)([(0,m.$)("esri.layers.support.rasterDatasets.BaseRaster")],H)},86769:(e,t,i)=>{function n(e,t){if(!e||!t)return[];let i=t;t.includes("/")?(i=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";const r=[];if(t){const s=n(e,i);for(let e=0;e<s.length;e++)n(s[e],t).forEach(e=>r.push(e));return r}const s=e.getElementsByTagNameNS("*",i);if(!s||0===s.length)return[];for(let n=0;n<s.length;n++)r.push(s[n]||s.item(n));return r}function r(e,t){if(!e||!t)return null;let i=t;t.includes("/")?(i=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";const s=n(e,i);return s.length>0?t?r(s[0],t):s[0]:null}function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=t?r(e,t):e;let n;return i?(n=i.textContent||i.nodeValue,n?n.trim():null):null}function o(e,t){const i=n(e,t),r=[];let s;for(let n=0;n<i.length;n++)s=i[n].textContent||i[n].nodeValue,s&&(s=s.trim(),""!==s&&r.push(s));return r}function l(e){var t;const i=s(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:null);return null!==(t=null===i||void 0===i?void 0:i.split(" ").map(e=>Number(e)))&&void 0!==t?t:[]}function a(e,t){return o(e,t).map(e=>Number(e))}function c(e,t){const i=s(e,t);return Number(i)}function u(e,t){var i;const n=null===e||void 0===e||null===(i=e.nodeName)||void 0===i?void 0:i.toLowerCase(),r=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===r}function h(e){return e.nodeName.slice(e.nodeName.lastIndexOf(":")+1)}i.d(t,{Dy:()=>o,IC:()=>n,Ui:()=>a,V6:()=>r,g7:()=>u,mX:()=>s,pN:()=>l,v7:()=>c,vv:()=>h})}}]);
//# sourceMappingURL=7933.77a08954.chunk.js.map