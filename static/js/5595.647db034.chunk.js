"use strict";(self.webpackChunkn2_depot=self.webpackChunkn2_depot||[]).push([[5595],{5109:(e,t,i)=>{i.d(t,{k:()=>o});var s=i(6326),r=i(68134),a=(i(76460),i(81806),i(47249),i(50076),i(87990)),n=i(56829);let o=class extends n.g{constructor(e){super(e)}initialize(){this.addHandles((0,r.wB)(()=>this.analysisViewData.visible,e=>this.visible=e,r.pc))}deactivate(){this.onDeactivate(),this.created||this.analysis.clear()}resetCreated(){this._set("created",!1)}};o=(0,s.Cg)([(0,a.$)("esri.views.interactive.AnalysisToolBase")],o)},10260:(e,t,i)=>{i.d(t,{Hd:()=>l,ZX:()=>h,aS:()=>d,qW:()=>c});var s=i(98773),r=i(54901),a=i(30726),n=i(50346),o=i(68134);function l(e,t){return(0,o.wB)(()=>e.interactive,()=>function(e,t){e.interactive?function(e,t){d(e);const{view:i,analysis:s}=e,r=new t({view:i,analysis:s,analysisViewData:e});e.tool=r,i.tools.add(r)}(e,t):d(e)}(e,t),o.pc)}function d(e){const{view:t,tool:i}=e;null!=i&&(t.tools.remove(i),e.tool=null)}function c(e,t){var i;const l=e.userOperation,d=(0,s.UT)(async i=>{var d;if(l){const e=l.promise.catch(()=>{});null!==l&&void 0!==l&&l.abort(),await e,(0,n.Te)(i)}const c=function(e,t){e.interactive=!0;const{tool:i,view:r}=e;r.activeTool=i;let l=(0,n.u7)(t,()=>{r.activeTool===i&&(r.activeTool=null)});return(0,s.UT)(async t=>{await(0,o.C_)(()=>{var t;return!(null!==(t=e.tool)&&void 0!==t&&t.active)},t),l=(0,a.xt)(l)},t)}(e,{signal:i}),h=null!==(d=null===t||void 0===t?void 0:t.shouldRejectOnCancel)&&void 0!==d?d:()=>!0,u=(0,r.vE)([(0,o.on)(()=>e.tool,"cancel",()=>{h()&&c.abort()})]),{tool:v}=e;try{var p;v&&(v.resetCreated(),null!==t&&void 0!==t&&null!==(p=t.onToolActivated)&&void 0!==p&&p.call(t,v)),await c.promise,(0,n.Te)(i)}catch(w){if(i.aborted||!(0,n.zf)(w)||h())throw w}finally{null===u||void 0===u||u.remove()}},{signal:null===t||void 0===t||null===(i=t.abortOptions)||void 0===i?void 0:i.signal});return e.userOperation=d,d.promise.finally(()=>{e.userOperation===d&&(e.userOperation=null)})}async function h(e,t){const i=e.analysis.clone();return await c(e,{abortOptions:null===t||void 0===t?void 0:t.placementOptions,onToolActivated:null===t||void 0===t?void 0:t.onToolActivated,shouldRejectOnCancel:()=>{const{analysis:t}=e;return!t.valid||t.equals(i)}}),{}}},27456:(e,t,i)=>{i.d(t,{V:()=>y,a:()=>R,b:()=>C});var s,r,a=i(57528),n=i(34761),o=i(13191),l=i(73398),d=i(65058),c=i(36324),h=i(30041),u=i(95756),v=i(5517),p=i(21390),w=i(60205),g=i(86955),f=i(72790),_=i(23687),m=i(44640),b=i(4653),V=i(70367),M=i(2687);class y extends h.${constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=o.zK.flat(),this.viewMatrices=o.zK.flat(),this.volumeOffset=0}}function C(){const e=new M.N5,t=e.fragment;return e.include(l.c),e.include(h.w),t.include(d.E),t.include(c.p),t.uniforms.add(new b.x("depthTexture",e=>{var t;return null===(t=e.depth)||void 0===t?void 0:t.attachment}),new _.F("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new _.F("inverseViewNormalMatrix",e=>{let{camera:t}=e;return(0,n.Qw)(S,t.viewInverseTransposeMatrix)}),new v.t("viewshedObserverOffset",e=>e.observerOffset),new v.t("viewshedTargetVector",e=>e.targetVector),new v.t("viewshedUpVector",e=>e.upVector),new u.G("viewshedFOVs",e=>e.fovs),new u.G("viewshedHeadingAndTilt",e=>e.headingAndTilt),new u.G("viewshedNearFar",e=>{var t;return null!==(t=e.shadowMap.nearFar)&&void 0!==t?t:[1,100]}),new p.m("viewshedVolumeOffset",e=>e.volumeOffset),new V.N("viewshedShadowMap",e=>e.shadowMap.depthTexture),new m.m("viewshedProjectionMatrices",e=>e.projectionMatrices,6),new m.m("viewshedViewMatrices",e=>e.viewMatrices,6),new f.c("viewshedNumFaces",e=>e.shadowMap.numActiveFaces),new w.x("viewshedAtlasRegions",e=>e.shadowMap.atlasRegions.flat(),24),new V.N("normalMap",e=>e.normals)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add((0,g.H)(s||(s=(0,a.A)(["vec2 getViewshedUv(vec4 worldPosition, int face) {\nmat4 viewshedMatrix = viewshedProjectionMatrices[face];\nvec4 viewshedUv4 = viewshedMatrix * worldPosition;\nvec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;\nreturn viewshedUv.xy;\n}\nfloat viewshedDepthToFloat(float depth) {\nreturn (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);\n}\nfloat getOrthographicDepthToViewshed(vec4 worldPosition, int face) {\nmat4 viewshedViewMatrix = viewshedViewMatrices[face];\nvec4 viewshedUv4 = viewshedViewMatrix * worldPosition;\nvec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;\nfloat depth = -viewshedUv.z;\nreturn viewshedDepthToFloat(depth);\n}\nfloat viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {\nreturn texelFetch(_viewshedShadowmap, uv, 0).r;\n}\nfloat viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {\nvec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));\nvec2 st    = fract(uvScaled);\nivec2 base = ivec2(uvScaled);\nfloat s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));\nfloat s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));\nfloat s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));\nfloat s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));\nreturn mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);\n}\nfloat viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {\nvec2 atlasScale = atlasRegion.zw - atlasRegion.xy;\nvec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;\nreturn viewshedFilterShadow(_viewshedShadowmap, uvAtlas);\n}\nfloat getDepthFromShadowMap(vec2 uv, int face) {\nint index = 4 * face;\nfloat umin = viewshedAtlasRegions[index];\nfloat umax = viewshedAtlasRegions[index + 1];\nfloat vmin = viewshedAtlasRegions[index + 2];\nfloat vmax = viewshedAtlasRegions[index + 3];\nvec4 atlasRegion = vec4(umin, vmin, umax, vmax);\nreturn viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);\n}\nstruct ViewshedPoint {\nint face;\nvec2 uv;\nbool isWithin;\nfloat orthographicDepth;\n};\nmat3 rotationMatrix(vec3 axis, float angle)\n{\nfloat s = sin(angle);\nfloat c = cos(angle);\nfloat oc = 1.0 - c;\nreturn mat3(\noc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),\noc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),\noc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)\n);\n}\nfloat distanceToPlane(vec3 position, vec3 normal) {\nreturn dot(position, normal);\n}\nbool outsideViewshed(float distance) {\nreturn distance > -viewshedVolumeOffset;\n}\nbool isWithinViewshed(vec3 position) {\nfloat positionLength = length(position - viewshedObserverOffset);\nfloat farSphereDistance = positionLength - viewshedNearFar[1];\nif (outsideViewshed(farSphereDistance)) { return false; }\nfloat nearSphereDistance = viewshedNearFar[0] - positionLength;\nif (outsideViewshed(nearSphereDistance)) { return false; }\nvec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));\nbool leftOfTarget = distanceToPlane(position, westVector) > 0.0;\nif (viewshedFOVs[0] < TWO_PI) {\nfloat horAngle = viewshedFOVs[0] / 2.0;\nhorAngle = leftOfTarget ? horAngle : -horAngle;\nvec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);\nbool inFront = distanceToPlane(position, sideVector) > 0.0;\nif (inFront) {\nvec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);\nfloat sideDistance = distanceToPlane(position, normalize(sideNormal));\nif (outsideViewshed(sideDistance)) { return false; }\n} else if (viewshedFOVs[0] < PI) { return false; }\n}\nif (viewshedFOVs[1] < PI) {\nfloat t = dot(viewshedUpVector, position);\nvec3 nProjVector = normalize(position - t * viewshedUpVector);\nfloat heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));\nheading = leftOfTarget ? heading : -heading;\nbool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;\nfloat verFOV = viewshedFOVs[1] / 2.0;\nverFOV = aboveTarget ? -verFOV : verFOV;\nmat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);\nvec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;\nvec3 leftVector = westVector * rotateByHeading;\nvec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);\nfloat sideDistance = distanceToPlane(position, normalize(sideNormal));\nif (outsideViewshed(sideDistance)) { return false; }\n}\nreturn true;\n}\nbool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {\nfor(int i=0; i < viewshedNumFaces; i++) {\nvec2 viewshedUv = getViewshedUv(localPosition, i);\nif (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {\nfloat orthoDepth = getOrthographicDepthToViewshed(localPosition, i);\nif (orthoDepth >= 0.) {\nbool isWithin = isWithinViewshed(localPosition.xyz);\npoint = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);\nreturn true;\n}\n}\n}\nreturn false;\n}\nfloat normalCosAngle(float linearDepth, vec3 localPosition) {\nvec4 normal4 = texture(normalMap, uv);\nvec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);\nvec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);\nvec3 viewingDir = normalize(localPosition);\nreturn dot(normal, viewingDir);\n}"])))),t.main.add((0,g.H)(r||(r=(0,a.A)(["float depth = depthFromTexture(depthTexture, uv);\nif (depth >= 1.0 || depth <= 0.0) {\nreturn;\n}\nfloat linearDepth = linearizeDepth(depth);\nvec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);\nViewshedPoint point;\nbool foundFace = getViewshedPoint(localPosition, point);\nif (!foundFace || !point.isWithin) {\nreturn;\n}\nfloat viewshedDepth = getDepthFromShadowMap(point.uv, point.face);\nfloat distance = point.orthographicDepth;\nbool visible = distance < viewshedDepth;\nfragColor = visible ? visibleColor : occludedColor;\nfloat cosAngle = normalCosAngle(linearDepth, localPosition.xyz);\nfloat threshold = -0.01;\nif (cosAngle > threshold) {\nfragColor = occludedColor;\n}"])))),e}const S=(0,o.vt)(),R=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:y,build:C},Symbol.toStringTag,{value:"Module"}))},30041:(e,t,i)=>{i.d(t,{$:()=>u,w:()=>v});var s,r=i(57528),a=i(34761),n=i(13191),o=i(9392),l=i(27963),d=i(86955),c=i(43425),h=i(31432);class u extends h.Y{constructor(){super(...arguments),this.localOrigin=(0,o.Ul)()}}function v(e){e.include(l.Ir),e.fragment.uniforms.add(new c.X("inverseViewMatrix",(e,t)=>{const i=(0,a.Tl)((0,n.vt)(),t.camera.viewMatrix,e.localOrigin);return(0,a.Qw)(i,i)})).code.add((0,d.H)(s||(s=(0,r.A)(["vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {\nvec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);\nreturn inverseViewMatrix * cameraSpace;\n}"]))))}},32864:(e,t,i)=>{i.d(t,{A:()=>p});var s=i(6326),r=i(42251),a=i(69098),n=i(73582),o=i(42553),l=i(30726),d=i(46053),c=i(21403),h=(i(81806),i(47249),i(87990)),u=i(40565),v=i(19247);let p=class extends((0,o.T)(a.Pw)){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45,this.feature=null}get valid(){return null!=this.observer&&this.farDistance>0}equals(e){return(0,l.CM)(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView&&(0,r.xH)(this.feature,e.feature)}};(0,s.Cg)([(0,d.MZ)({type:v.A,json:{write:{isRequired:!0}}})],p.prototype,"observer",void 0),(0,s.Cg)([(0,d.MZ)({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],p.prototype,"farDistance",void 0),(0,s.Cg)([(0,d.MZ)({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),(0,c.w)(e=>n.ie.normalize((0,u.GB)(e),void 0,!0))],p.prototype,"heading",void 0),(0,s.Cg)([(0,d.MZ)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],p.prototype,"tilt",void 0),(0,s.Cg)([(0,d.MZ)({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}})],p.prototype,"horizontalFieldOfView",void 0),(0,s.Cg)([(0,d.MZ)({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],p.prototype,"verticalFieldOfView",void 0),(0,s.Cg)([(0,d.MZ)(r.N1)],p.prototype,"feature",void 0),(0,s.Cg)([(0,d.MZ)({readOnly:!0,json:{read:!1}})],p.prototype,"valid",null),p=(0,s.Cg)([(0,h.$)("esri.analysis.Viewshed")],p)},35925:(e,t,i)=>{i.d(t,{Xq:()=>o,wk:()=>n});const s={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},r={dash:s.dash,"dash-dot":[...s.dash,...s.dot],dot:s.dot,"long-dash":s["long-dash"],"long-dash-dot":[...s["long-dash"],...s.dot],"long-dash-dot-dot":[...s["long-dash"],...s.dot,...s.dot],none:null,"short-dash":s["short-dash"],"short-dash-dot":[...s["short-dash"],...s["short-dot"]],"short-dash-dot-dot":[...s["short-dash"],...s["short-dot"],...s["short-dot"]],"short-dot":s["short-dot"],solid:null},a=8;function n(e){return{pattern:[e,e],pixelRatio:2}}function o(e){return"style"===(null===e||void 0===e?void 0:e.type)?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(r[e],a):null}(e.style):null}},42251:(e,t,i)=>{i.d(t,{N1:()=>d,uY:()=>c,wY:()=>l,xH:()=>o});var s=i(20664),r=i(9392),a=i(95925),n=i(92690);function o(e,t){return l(e)===l(t)}function l(e){if(null==e)return null;const t=null!=e.layer?e.layer.id:"";let i=null;return i=null!=e.objectId?e.objectId:null!=e.layer&&"objectIdField"in e.layer&&null!=e.layer.objectIdField&&null!=e.attributes?e.attributes[e.layer.objectIdField]:e.uid,null==i?null:"o-".concat(t,"-").concat(i)}const d={json:{write:{writer:function(e,t){var i;null!=(null===e||void 0===e||null===(i=e.layer)||void 0===i?void 0:i.objectIdField)&&null!=e.attributes&&(t.feature={layerId:e.layer.id,objectId:e.attributes[e.layer.objectIdField]})},target:{"feature.layerId":{type:[Number,String],isRequired:!0},"feature.objectId":{type:[Number,String],isRequired:!0}}},origins:{"web-scene":{read:function(e){if(null!=e.layerId&&null!=e.objectId)return{uid:null,layer:{id:e.layerId,objectIdField:"ObjectId"},attributes:{ObjectId:e.objectId}}}}}},clonable:"reference"};function c(e,t,i,o){var d,c;const{sceneIntersectionHelper:u}=e,{observer:w,observerFeatureId:g,targetFeatureId:f,target:_}=i;if(null==g&&null==f)return;o||(o=e=>e),(0,s.a)(p,w,_);const m=(0,s.b)(p);(0,s.c)(p,w,p,1/m);const b=(0,a.Cr)(p,_,v);t.options.store=2,u.intersectToolIntersectorRay(b,t);let V=null,M=null,y=null,C=null;for(const s of t.results.all){const t=(0,n.Gy)(s,e);if(null==t||null==s.distanceInRenderSpace)continue;const i=l(t);null!=i&&(null!=g&&i===g&&(null!==V&&void 0!==V||(V=o(h(s,e,m))),s.distanceInRenderSpace-1<V&&(y=s)),null!=f&&i===f&&(null!==M&&void 0!==M||(M=o(h(s,e,m))),null==C&&s.distanceInRenderSpace-1<m&&m-s.distanceInRenderSpace+1<M&&(C=s)))}const{observerAdjusted:S,targetAdjusted:R}=i;null!==(d=y)&&void 0!==d&&d.getIntersectionPoint(S)?i.observerSurfaceNormal=y.getTransformedNormal((0,r.vt)()):i.observerSurfaceNormal=null,null!==(c=C)&&void 0!==c&&c.getIntersectionPoint(R)?i.targetSurfaceNormal=C.getTransformedNormal((0,r.vt)()):i.targetSurfaceNormal=null}function h(e,t,i){if((0,n.QS)(e)){const s=(0,n.SM)(e,t);if(null!=s)return Math.min(s*u,i)}return 1e-5*i}const u=.05,v=(0,a.vt)(),p=(0,r.vt)()},46576:(e,t,i)=>{i.d(t,{T:()=>r});var s=i(96342);function r(e){const t=new s.n(e);return t.options.store=0,t.options.excludeLabels=!0,t}},63928:(e,t,i)=>{i.d(t,{W:()=>a});var s=i(45463),r=i(48168);class a extends s.i{intersect(e,t,i,s,a,n){return(0,r.Uy)(e,i,s,a,void 0,n)}intersectDraped(e,t,i,s){return(0,r.gz)(i[0],i[1],e,s)}}},72205:(e,t,i)=>{i.d(t,{P:()=>c});var s=i(6326),r=(i(76460),i(81806),i(47249),i(50076),i(87990)),a=i(54099),n=i(54901),o=i(91291),l=i(46053);let d=class extends((0,o.g)(a.nJ)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(e){this._userInteractive=e}get updating(){return!1}get visible(){var e,t;return null===(e=(null===(t=this.parent)||void 0===t?void 0:t.visible)&&!this.parent.suspended)||void 0===e||e}set visible(e){this._overrideIfSome("visible",e)}forceInteractive(){return this._interactiveViewModelCount++,(0,n.hA)(()=>this._interactiveViewModelCount--)}};(0,s.Cg)([(0,l.MZ)({constructOnly:!0})],d.prototype,"parent",void 0),(0,s.Cg)([(0,l.MZ)({constructOnly:!0})],d.prototype,"view",void 0),(0,s.Cg)([(0,l.MZ)({type:Boolean})],d.prototype,"interactive",null),(0,s.Cg)([(0,l.MZ)()],d.prototype,"_userInteractive",void 0),(0,s.Cg)([(0,l.MZ)({readOnly:!0})],d.prototype,"updating",null),(0,s.Cg)([(0,l.MZ)()],d.prototype,"visible",null),(0,s.Cg)([(0,l.MZ)()],d.prototype,"_interactiveViewModelCount",void 0),d=(0,s.Cg)([(0,r.$)("esri.views.analysis.AnalysisView")],d);let c=class extends d{};c=(0,s.Cg)([(0,r.$)("esri.views.3d.analysis.AnalysisView3D")],c)},74050:(e,t,i)=>{i.d(t,{Dh:()=>o,IB:()=>d,fg:()=>n,jI:()=>l});i(15941);var s=i(19555),r=i(72745);function a(e,t){return e[0]*t[1]-e[1]*t[0]}function n(e,t,i,r){let a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:i;return(0,s.Re)(h,r,i),(0,s.Re)(v,t,a),function(e,t,i){const r=(0,s.Om)(i,t)/(0,s.m3)(i);(0,s.hs)(e,i,r)}(p,v,h),(0,s.WQ)(e,a,p)}function o(e,t,i,r){(0,s.Re)(h,t,i);const a=r/(0,s.Bw)(h);return(0,s.Ln)(e,i,h,a)}function l(e,t){const i=e.start,r=e.end,n=t.start,o=t.end,l=(0,s.Re)(h,r,i),d=(0,s.Re)(u,o,n),w=a(l,d);if(Math.abs(w)<=c)return[];const g=(0,s.Re)(v,i,n),f=a(d,g)/w,_=a(l,g)/w;if(f>=0){if(_>=0||1===t.type)return[(0,s.Ln)(p,i,l,f)]}else if(1===e.type&&(_>=0||1===t.type))return[(0,s.Ln)(p,i,l,f)];return[]}function d(e,t,i){const r=[],a=(0,s.Re)(h,e.end,e.start),n=(0,s.Re)(u,e.start,t),o=(0,s.m3)(a),l=2*(0,s.Om)(a,n),d=l*l-4*o*((0,s.m3)(n)-i*i);if(0===d){const t=-l/(2*o);(1===e.type||t>=0)&&r.push((0,s.Ln)(p,e.start,a,t))}else if(d>0){const t=Math.sqrt(d),i=(-l+t)/(2*o);(1===e.type||i>=0)&&r.push((0,s.Ln)(p,e.start,a,i));const n=(-l-t)/(2*o);(1===e.type||n>=0)&&r.push((0,s.Ln)(v,e.start,a,n))}return r}const c=1e-6,h=(0,r.vt)(),u=(0,r.vt)(),v=(0,r.vt)(),p=(0,r.vt)()},85540:(e,t,i)=>{i.r(t),i.d(t,{default:()=>qt});var s=i(6326),r=i(42251),a=i(81806),n=i(76460),o=i(43927),l=i(30726),d=i(68134),c=i(46053),h=(i(47249),i(87990)),u=i(20664),v=i(9392),p=i(56611),w=i(50840),g=i(2413),f=i(72205),_=i(17430),m=i(91967),b=i(15941),V=i(13191),M=i(19247),y=i(89379),C=i(34761),S=i(13927),R=i(69539);const D=(0,b.kU)(2);const O=new class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=4,this.fovFocusedArcWidth=2*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=2/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}};const A=new class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new R.A([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:R.A.toUnitRGBA(new R.A([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:1,cullFace:2,writeDepth:!1}}};var T=i(38317),x=i(7947),F=i(5101),P=i(71372);function E(e,t){let{tiltedUpVector:i,rightVector:s,observerRenderSpace:r}=e;const a=(0,T.wQ)(i,s,r,t);return a[12]=0,a[13]=0,a[14]=0,a}function H(e,t,i,s){const r=(0,v.vt)(),a=(0,S.Qj)(i.plane),n=function(e,t){const i=Z;e.renderCoordsHelper.toRenderCoords(e.camera.position,i);const s=(0,F.ZC)(e,i,e.camera.heading,e.camera.tilt,(0,P.NP)()).direction;return(0,b.KJ)((0,u.p)(s,t))-90}(t,a);let o;if(Math.abs(n)>O.viewAngleThreshold)o=e.next((0,x.AA)(t,i.plane));else{const r=(0,S.O_)(s.targetRenderSpace,i.basis1,(0,S.vt)()),a=(0,u.n)(Z,i.basis1),n=(0,u.n)(I,i.basis2);o=e.next((0,x.AA)(t,r)).next(e=>{const t=e=>{const t=(0,u.f)((0,u.a)(U,e,i.origin),n),r=Math.acos((0,b.qE)(t/s.farDistanceRenderSpace,-1,1)),o=Math.sin(r)*s.farDistanceRenderSpace;return(0,u.g)((0,v.vt)(),i.origin,(0,u.g)((0,v.vt)(),(0,u.h)(U,a,o),(0,u.h)(j,n,t)))},r=t(e.renderStart),o=t(e.renderEnd);return(0,y.A)((0,y.A)({},e),{},{renderStart:r,renderEnd:o})})}return o.next(e=>{"start"===e.action&&(0,u.d)(r,e.renderStart);const t=(0,b.KJ)((0,T.FY)(r,e.renderEnd,i.origin,a));return(0,y.A)((0,y.A)({},e),{},{deltaAngle:t})})}function z(e,t,i,s){return(0,C.$0)(k,i,s),(0,u.t)(e,t,k)}const Z=(0,v.vt)(),I=(0,v.vt)(),U=(0,v.vt)(),j=(0,v.vt)(),k=(0,V.vt)();var L;let N=L=class extends m.A{constructor(e){super(e),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){var e;return null!==(e=this.viewshed.observer)&&void 0!==e?e:new M.A}get effectiveObserverRenderSpace(){var e;return null!==(e=this.observerRenderSpaceOverride)&&void 0!==e?e:this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,(0,v.vt)())}get target(){const e=this.targetRenderSpace;return this.renderSpaceToPoint(e,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const e=(0,u.a)((0,v.vt)(),this.targetRenderSpace,this.observerRenderSpace);return(0,u.n)(e,e)}get tiltedUpVector(){const e=z((0,v.vt)(),this.upVector,-(0,b.kU)(this.tiltParallelToSurface),this.leftVector);return(0,u.n)(e,e)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,(0,V.vt)())}get upVector(){const e=this._basis;return(0,v.fA)(e[8],e[9],e[10])}get northVector(){const e=this._basis;return(0,v.fA)(e[4],e[5],e[6])}get leftVector(){const e=this.upVector,t=z((0,v.vt)(),this.northVector,-(0,b.kU)(this.heading),e);return(0,u.i)(t,e,t)}get rightVector(){return(0,u.u)((0,v.vt)(),this.leftVector)}clone(){return new L({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(e,t,i){const{observerRenderSpace:s,targetRenderSpace:r}=this,a=(0,u.a)(B,r,s);return z(a,a,-(0,b.kU)(t),this.leftVector),z(a,a,-(0,b.kU)(e),this.tiltedUpVector),(0,u.g)(i,a,s)}cornerPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-t,i,e.topLeft),this.pointOnSphere(t,i,e.topRight),this.pointOnSphere(-t,-i,e.bottomLeft),this.pointOnSphere(t,-i,e.bottomRight)}arcCentersPoints(e){const t=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,e.top),this.pointOnSphere(0,-i,e.bottom),this.pointOnSphere(-t,0,e.left),this.pointOnSphere(t,0,e.right)}parallelCenterPoints(e){const t=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin((0,b.kU)(this.verticalFieldOfView/2)),s=(0,u.h)(B,this.tiltedUpVector,i);(0,u.g)(e.top,t,s),(0,u.a)(e.bottom,t,s)}renderSpaceToPoint(e,t){const i=B;return this.renderCoordsHelper.fromRenderCoords(e,i,t),new M.A(i[0],i[1],i[2],t)}_pointToRenderSpace(e,t){const i=(0,v.ci)(e.toArray());return this.renderCoordsHelper.toRenderCoords(i,e.spatialReference,t),t}_computeTargetRenderSpace(e){const{leftVector:t,northVector:i,upVector:s}=this,r=this.farDistanceRenderSpace,a=(0,v.vt)();return(0,u.h)(a,i,r),z(a,a,-(0,b.kU)(this.heading),s),z(a,a,-(0,b.kU)(this.tiltParallelToSurface),t),(0,u.g)(a,e,a),a}};(0,s.Cg)([(0,c.MZ)()],N.prototype,"renderCoordsHelper",void 0),(0,s.Cg)([(0,c.MZ)()],N.prototype,"viewshed",void 0),(0,s.Cg)([(0,c.MZ)()],N.prototype,"observerRenderSpaceOverride",void 0),(0,s.Cg)([(0,c.MZ)()],N.prototype,"needUpdateByFeature",void 0),(0,s.Cg)([(0,c.MZ)()],N.prototype,"observer",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"effectiveObserverRenderSpace",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"effectiveObserver",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"effectiveTargetRenderSpace",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"farDistance",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"farDistanceRenderSpace",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"heading",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"tilt",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"feature",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"tiltParallelToSurface",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"horizontalFieldOfView",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"verticalFieldOfView",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"observerRenderSpace",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"target",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"targetRenderSpace",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"targetDirection",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"tiltedUpVector",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"_basis",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"upVector",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"northVector",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"leftVector",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"rightVector",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"valid",null),(0,s.Cg)([(0,c.MZ)()],N.prototype,"metersPerUnit",null),N=L=(0,s.Cg)([(0,h.$)("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],N);const B=(0,v.vt)();var G=i(32864),W=i(54901),q=i(18690),$=i(98773),K=i(73582),X=i(50346),Q=i(64465),J=i(88321),Y=i(79650),ee=i(56121),te=i(91175),ie=i(36452),se=i(72017),re=i(86994),ae=i(52479),ne=i(17046);class oe extends ie.A{constructor(e){super(),this._handles=new J.A,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=(0,l.pR)(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,t){const i=Object.values(this._manipulators);return(0,W.vE)(i.map(i=>{let{manipulator:s,side:r}=i;return(0,ne.Xt)(s,(i,s,a,n,o)=>{const l=function(e,t){let{observerRenderSpace:i,targetRenderSpace:s,tiltedUpVector:r,rightVector:a,farDistanceRenderSpace:n}=t;const o=(0,u.a)(he,s,i),l=le(e)?a:r,d=(0,u.h)(ue,l,n);return(0,Y.f)(i,o,d)}(r,t),d=s.next(e=>(0,y.A)((0,y.A)({},e),{},{manipulatorType:2,side:r})),c=H(d,this._view,l,t);e(i,c,a)})}))}updateManipulatorsTransform(e){e.arcCentersPoints(ve),this._forEachManipulatorInfo(t=>this._updateArcManipulatorTransform(t,e,ve[t.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(t=>this._updateArcManipulatorVisuals(t,e))}_updateArcManipulatorVisuals(e,t){let{manipulator:i,side:s}=e;const r=[];if(null!=t){const[e,a]=function(e,t,i){const{horizontalFieldOfView:s,verticalFieldOfView:r}=t,a=le(e),n=(0,b.kU)((0,b.qE)((a?r:s)/2,0,15)),o=function(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;(0,re.vA)(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const r=t-e;if(r<=0||i<=0){const e=.01;return[(0,v.fA)(0,0,e),(0,v.fA)(0,0,-e)]}const a=[],n=r/s;for(let o=0;o<s;o++){let r=e+o*n;o===s-1&&(r=t);const l=Math.cos(r)*i,d=Math.sin(r)*i,c=(0,v.fA)(l-i,0,d);a.push(c)}return a}(-n/2,n/2,a?1:Math.max(Math.sin((0,b.kU)(90-r/2)),.1));return[(0,se.Z8)(i,o),o]}(s,t,this._unfocusedArcMaterial);r.push(new te.M(e,1),new te.M(e.instantiate({material:this._focusedArcMaterial}),2)),i.collisionType={type:"line",paths:[a]}}i.renderObjects=r,i.radius=O.collisionRadius}_updateArcManipulatorTransform(e,t,i){let{manipulator:s,side:r}=e;const a=t.horizontalFieldOfView,n=(0,b.kU)(t.verticalFieldOfView/2),o=(0,b.kU)(a/2),l=le(r);s.renderLocation=i;const d=(0,V.vt)(),c=e=>{(0,C.lw)(d,e,d)};c((0,C.i1)(ce,(0,b.kU)(-90))),l||c((0,C.hM)(ce,n));const h=t.farDistanceRenderSpace;let v,p;c((0,C.CV)(ce,(0,u.j)(he,h,h,h))),c((0,C.N9)(ce,function(e){return function(e){switch(e){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}(e)*de}(r))),c(E(t,ce)),l?(v=o,p=t.tiltedUpVector):(p=t.rightVector,v=n),v*="right"===r||"bottom"===r?-1:1;const w=(0,C.$0)(ce,v,p);null!=w&&c(w),s.modelTransform=d}_createManipulators(){const e=this._createArcManipulator("left"),t=this._createArcManipulator("right"),i=this._createArcManipulator("top"),s=this._createArcManipulator("bottom");this._manipulators={left:e,right:t,top:i,bottom:s},[[s.manipulator,i.manipulator],[e.manipulator,t.manipulator]].forEach(e=>{let[t,i]=e;t.metadata={pairedManipulator:i},i.metadata={pairedManipulator:t}})}_createArcManipulator(e){const t=new ee.q({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:t,side:e};return this._updateArcManipulatorVisuals(i),this._handles.add(t.events.on(["focus-changed","grab-changed"],e=>{var i;const s=null===(i=t.metadata)||void 0===i?void 0:i.pairedManipulator;null!=s&&(s.hovering!==t.hovering&&(s.hovering=t.hovering),s.grabbing!==t.grabbing&&(s.grabbing=t.grabbing))})),i}_createArcMaterial(e){const t=O.getFovArcWidth(e),i=new ae.W({renderOccluded:4,isDecoration:!0,width:t},this._view.state.isGlobal);return this._handles.add((0,d.wB)(()=>R.A.toUnitRGBA(this._view.effectiveTheme.accentColor),e=>i.setParameters({color:e}),d.Vh)),i}forEachManipulator(e){Object.values(this._manipulators).forEach(t=>{let{manipulator:i}=t;return e(i,2)})}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(t=>e(t))}get test(){return{manipulators:this._manipulators}}}function le(e){return"left"===e||"right"===e}const de=Math.PI/2,ce=(0,V.vt)(),he=(0,v.vt)(),ue=(0,v.vt)(),ve={top:(0,v.vt)(),bottom:(0,v.vt)(),left:(0,v.vt)(),right:(0,v.vt)()};var pe=i(95925),we=i(93131),ge=i(76956);class fe extends ee.q{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:O.collisionRadius}),this._handles=new J.A,this._setupManipulatorVisual(t)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){const t=this._createMaterial(),i=[(0,v.fA)(0,0,0),(0,v.fA)(0,0,1)],s=(0,se.Nb)(t,i,e,16,!1),r=(0,se.Nb)(t,i,e*we.UF,16,!1),a=_e(!1,t,e),n=_e(!0,t,e),o=(0,V.vt)();(0,C.kN)(o,i[i.length-1]),(0,C.lK)(o,o,(0,C.hM)(me,Math.PI/2)),(0,C.lK)(o,o,(0,C.i1)(me,Math.PI/2)),a.transformation=o,n.transformation=o,this.renderObjects=[new te.M(s,1),new te.M(r,2),new te.M(a,1),new te.M(n,2)];const l=(0,v.fA)(0,O.getScaleOrientArrowTipLength(!0),0),d=(0,u.t)(l,l,o),c=[...i,d];this.collisionType={type:"line",paths:[c]}}_createMaterial(){const e=new ge.v({cullFace:2,renderOccluded:4,isDecoration:!0});return this._handles.add((0,d.wB)(()=>R.A.toUnitRGBA(this.view.effectiveTheme.accentColor),t=>e.setParameters({color:t}),d.Vh)),e}}function _e(e,t,i){const s=O.getScaleOrientArrowTipLength(e);let r=2*i;e&&(r*=we.UF);const a=s/2;return(0,se._B)(t,s,a,a,r,0)}const me=(0,V.vt)();var be=i(46947);class Ve extends ie.A{constructor(e){super(),this._handles=new J.A,this._tool=e.tool,this._view=e.view;const t=O.scaleOrientHandleRadius;this._manipulatorHeading=new fe(this._view,t),this._manipulatorTilt=new fe(this._view,t),this._manipulatorDistance=new fe(this._view,t),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,t){return(0,ne.Xt)(this._manipulatorHeading,(i,s,r,a,n)=>{const o=this._view,{tiltParallelToSurface:l,farDistanceRenderSpace:d,upVector:c,observerRenderSpace:h,targetRenderSpace:v,rightVector:p}=t,w=Math.sin((0,b.kU)(l))*d,g=(0,u.g)(Ce,h,(0,u.h)(Se,c,w)),f=(0,u.a)(Se,v,g),_=(0,u.h)(Re,p,(0,u.H)(f)),m=H(s,o,(0,Y.f)(g,f,_),t).next(e=>(0,y.A)((0,y.A)({},e),{},{manipulatorType:3}));e(i,m,r)})}createTiltDragPipeline(e,t){return(0,ne.Xt)(this._manipulatorTilt,(i,s,r,a,n)=>{const{observerRenderSpace:o,farDistanceRenderSpace:l,upVector:d,targetDirection:c}=t,h=(0,u.f)(c,d),v=(0,u.c)(Ce,c,d,-h);(0,u.h)(v,(0,u.n)(v,v),l);const p=(0,u.h)(Se,d,l),w=(0,Y.f)(o,v,p),g=H(s,this._view,w,t).next(e=>(0,y.A)((0,y.A)({},e),{},{manipulatorType:3}));e(i,g,r)})}createDistanceDragPipeline(e,t){return(0,ne.Xt)(this._manipulatorDistance,(i,s,r,a,n)=>{const o=(0,pe.fA)(t.observerRenderSpace,t.targetDirection),l=s.next((0,ne.Tp)(this._view,i.location)).next((0,x.ov)(this._view,o)).next(e=>(0,y.A)((0,y.A)({},e),{},{manipulatorType:2}));e(i,l,r)})}updateManipulators(e){const{targetRenderSpace:t}=e;this._manipulatorHeading.renderLocation=t,this._manipulatorTilt.renderLocation=t,this._manipulatorDistance.renderLocation=t;const i=(0,V.vt)(),s=e=>{(0,C.lw)(i,e,i)},r=O.scaleOrientSize*(be.HJ/be.Gz);s((0,C.CV)(Me,(0,u.j)(Ce,r,r,r))),s(E(e,Me));const a=O.scaleOrientHandleRadius*we.UF*r,n=(0,u.h)(Ce,e.targetDirection,a);s((0,C.kN)(Me,n));const o=(0,C.N9)(Me,-De);(0,C.lK)(o,o,(0,C.i1)(ye,-De)),this._manipulatorHeading.modelTransform=(0,C.lK)((0,V.vt)(),i,o);const l=(0,C.i1)(Me,De);(0,C.lK)(l,l,(0,C.N9)(ye,Math.PI)),this._manipulatorTilt.modelTransform=(0,C.lw)((0,V.vt)(),i,l),this._manipulatorDistance.modelTransform=i}forEachManipulator(e){e(this._manipulatorHeading,3),e(this._manipulatorTilt,3),e(this._manipulatorDistance,2)}}const Me=(0,V.vt)(),ye=(0,V.vt)(),Ce=(0,v.vt)(),Se=(0,v.vt)(),Re=(0,v.vt)(),De=Math.PI/2;i(62754),i(50076);class Oe extends ee.q{constructor(e,t){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:O.observerSize,interactive:!1}),this._handles=new J.A;const i=(0,T.UM)(this._color);this.renderObjects=[new te.M((0,se.CM)(i,O.observerSize,32,32))],t.manipulators.add(this),this._handles.add([(0,d.wB)(()=>this._color,e=>{i.setParameters({color:e})},d.Vh)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return R.A.toUnitRGBA(this.view.effectiveTheme.accentColor)}}(0,s.Cg)([(0,c.MZ)()],Oe.prototype,"_color",null);var Ae=i(96999),Te=i(56497);const xe=Symbol("dragHandles"),Fe=Symbol("hideManipulators"),Pe=Symbol("hideFoVManipulators"),Ee=Symbol("hideObserverManipulator");let He=class extends m.A{constructor(e){super(e),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new oe({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Ve({view:this.view,tool:this.parentTool}),this._observerManipulator=new Oe(this.view,this.parentTool),this.addHandles([(0,d.wB)(()=>{var e;return null===(e=this.viewshedComputedData)||void 0===e?void 0:e.observerRenderSpace},e=>{null!=e&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},d.pc),(0,d.wB)(()=>{var e;return null===(e=this.viewshedComputedData)||void 0===e?void 0:e.heading},e=>{e&&(this._moveManipulation.angle=(0,b.kU)(90-e))},d.Vh),(0,d.wB)(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:null===e||void 0===e?void 0:e.observer}},(e,t)=>{let{viewshedComputedData:i,observer:s}=e;this._grabbing&&s!==(null===t||void 0===t?void 0:t.observer)||(this.removeHandles(xe),(null===i||void 0===i?void 0:i.valid)&&this.addHandles([this._buildObserverDragPipeline(i),this._buildFOVDragPipeline(i),this._buildScaleOrientDragPipeline(i)].filter(q.Ru),xe))},d.Vh),(0,d.wB)(()=>{const e=this.viewshedComputedData;return null!==e&&void 0!==e&&e.valid?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},d.Vh),(0,d.wB)(()=>{const e=this.viewshedComputedData;return null!==e&&void 0!==e&&e.valid?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{null!=e&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},d.Vh),(0,d.wB)(()=>{var e,t;const i=this.analysisViewData.visible&&null!==(e=null===(t=this.viewshedComputedData)||void 0===t?void 0:t.valid)&&void 0!==e&&e,s=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:i&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:i&&(!this.parentTool.creating||s)}},e=>{let{fovManipulationAvailable:t,nonFOVManipulationAvailable:i}=e;this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=t},d.Vh),(0,d.wB)(()=>{const e=this.viewshedComputedData;if(null===e||void 0===e||!e.valid)return null;const{observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}=e;return{viewshedCompData:e,observer:t,target:i,verticalFieldOfView:s,horizontalFieldOfView:r}},e=>{null!=e&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},d.Vh)]);this._forEachManipulator(e=>{const t=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{const e=this._someManipulatorHovering();e&&this.parentTool.subToolHandles.forEach(e=>{let{subTool:t}=e;t._resetHoveringTask()}),this._someManipulatorSelected()||e||(this._forceHoveringTask=(0,$.UT)(async e=>{var t;await(null!==(t=this._forceHoveringTestPromise)&&void 0!==t?t:(0,X.Pl)(O.hoverTimeoutMilliseconds,e)),(0,X.Te)(e),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),e.events.on("grab-changed",i=>{var s;this._grabbing="start"===i.action,"end"===i.action&&null!==(s=t.tool)&&void 0!==s&&s.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(e=>{let{subTool:t}=e;t!==this&&t._setInteractive(!this._grabbing)}),this._setInteractive(t=>t.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",e=>{var i;"start"===e.action&&(null===(i=t.tool)||void 0===i||i.updateInteractionVisualsVisibility())})])})}destroy(){this._forceHoveringTask=(0,l.DC)(this._forceHoveringTask),this._moveManipulation=(0,l.pR)(this._moveManipulation),this._fieldOfViewManipulation=(0,l.pR)(this._fieldOfViewManipulation),this._scaleOrientManipulation=(0,l.pR)(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=(0,l.pR)(this._observerManipulator)}get viewshed(){var e;return null===(e=this.viewshedComputedData)||void 0===e?void 0:e.viewshed}get grabbing(){return this._grabbing}get observer(){var e;return null===(e=this.viewshed)||void 0===e?void 0:e.observer}set observer(e){const t=this.viewshed;null!=t&&(t.observer=e)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:e,grabbing:t}=this._moveManipulation;return{dragging:e,grabbing:t}}get scaleOrientInteractionState(){const{dragging:e,grabbing:t}=this._scaleOrientManipulation;return{dragging:e,grabbing:t}}_setInteractive(e){const t="boolean"==typeof e;this._forEachManipulation(i=>i.interactive=t?e:e(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),this._someManipulatorSelected()||(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(e){let t=!1;return this._forEachManipulator(i=>{t=t||i===e}),t}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Ae.v({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:be.HJ})}_buildObserverDragPipeline(e){const t=e.observer;if(null==t)return null;const i=this.view.spatialReference;return this._moveManipulation.createDragPipeline((e,s,r,a,n)=>{a=a.next((0,ne.VG)(this,["observer"]));const o=(0,p.tryProjectWithZConversion)(t,i);if(null==o)return{steps:r,cancel:a};const l=Te.p.fromGeometry(o,(0,Q.y)(this.view.viewingMode));return{steps:r.next((0,ne.Wp)({operations:l})).next(e=>(this.observer=l.data.geometry,e)),cancel:a}},{mode:"absolute-height",offset:0},i,void 0)}_buildFOVDragPipeline(e){let t=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,r,a)=>{if(null==e)return{steps:r,cancel:a};const n=e.viewshed;let o=null;return a=a.next((0,ne.VG)(n,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(s=>{"start"===s.action&&(o=null,t=e.horizontalFieldOfView,i=e.verticalFieldOfView);const r=s.deltaAngle;if(null==o&&0!==r){const e="bottom"===s.side||"left"===s.side?r>0:r<0;o=le(s.side)?0===t&&e||360===t&&!e:0===i&&e}const a=o?function(e){return"left"===e?"right":"right"===e?"left":"top"===e?"bottom":"top"}(s.side):s.side;let l=0;switch(a){case"left":l=t/2-r;break;case"right":l=t/2+r;break;case"top":l=i+2*r;break;case"bottom":l=i-2*r}return le(a)?(l=K.ie.normalize(l),l=l>270?0:l>180?180:l,n.horizontalFieldOfView=2*l):n.verticalFieldOfView=l,s}),cancel:a}},e)}_buildScaleOrientDragPipeline(e){let t=0,i=0;const s=(t,i)=>(s,r,a)=>{if(null==e)return{steps:r,cancel:a};const n=e.viewshed;return a=a.next((0,ne.VG)(n,[t])),{steps:r=r.next(i(n,e)),cancel:a}};return(0,W.vE)([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(t,s)=>s=>("start"===s.action&&(i=e.heading),t.heading=K.ie.normalize(i+s.deltaAngle),s)),e),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(i,s)=>s=>{"start"===s.action&&(t=e.tilt);let r=t+s.deltaAngle;return r<-90?r=180:r>270&&(r=0),i.tilt=Ze.clamp(r),s}),e),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(e,t)=>i=>{const s=(0,u.a)(ze,i.renderEnd,t.observerRenderSpace),r=(0,u.H)(s)*t.metersPerUnit,a=(0,u.f)(s,t.targetDirection)<0?O.scaleOrientMinDistance:r;return e.farDistance=a,i}),e)])}_updateManipulatorVisibility(){const e=this._someManipulatorSelected(),t=null!=this._forceHoveringTask||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating;let r=[];const a=e=>{r.push(e.disableDisplay())};e||!s&&t?this.removeHandles(Fe):(this._scaleOrientManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a),this.addHandles(r,Fe),r=[]),e||!s&&t||s&&i?this.removeHandles(Pe):(this._fieldOfViewManipulation.forEachManipulator(a),this.addHandles(r,Pe)),e||!s?this.removeHandles(Ee):this.addHandles(this._observerManipulator.disableDisplay(),Ee)}_resetHoveringTask(){this._forceHoveringTask=(0,l.DC)(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(e){this._forEachManipulation(t=>{t.forEachManipulator(e)}),e(this._observerManipulator)}_forEachManipulation(e){e(this._moveManipulation),e(this._fieldOfViewManipulation),e(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:e=>{this._forceHoveringTestPromise=e}}}};(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],He.prototype,"analysis",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],He.prototype,"analysisViewData",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],He.prototype,"parentTool",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0,nonNullable:!0})],He.prototype,"view",void 0),(0,s.Cg)([(0,c.MZ)()],He.prototype,"viewshed",null),(0,s.Cg)([(0,c.MZ)()],He.prototype,"_grabbing",void 0),(0,s.Cg)([(0,c.MZ)()],He.prototype,"grabbing",null),(0,s.Cg)([(0,c.MZ)()],He.prototype,"viewshedComputedData",void 0),(0,s.Cg)([(0,c.MZ)()],He.prototype,"observer",null),He=(0,s.Cg)([(0,h.$)("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],He);const ze=(0,v.vt)(),Ze=new K.hr(0,180);var Ie=i(14835),Ue=i(75655),je=i(1307),ke=i(92690),Le=i(5109),Ne=i(82307),Be=i(46576),Ge=i(11500);const We=Symbol("interactionVisuals");let qe=class extends Le.k{constructor(e){super(e),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=tt,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Ie.w({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=(0,Be.T)(this.view.state.viewingMode),this._createInteractionVisuals();const e=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=(0,o.L)(()=>e,e=>{let{viewshedComputedData:t}=e;const i=new He({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:i,remove:()=>{this.selectedViewshed===t.viewshed&&(this.selectedViewshed=null),i.destroy()}}}),this.addHandles([(0,d.z7)(()=>this._valid,()=>this.finishToolCreation(),d.pc),(0,d.wB)(()=>this._stagedViewshed,e=>{var t;const i=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=null!=e&&null!=i?null===(t=this._findSubTool(e))||void 0===t?void 0:t.viewshedComputedData:null},d.pc),this.analysis.viewsheds.on("after-remove",e=>{const t=this._stagedViewshed;null!=t&&e.item===t&&this.analysis.viewsheds.add(t)}),(0,d.wB)(()=>this.firstGrabbedManipulator,e=>{var t;if(null!=e){var i;const t=null===(i=this._findSubTool(e))||void 0===i?void 0:i.viewshed;this.selectedViewshed=t,this._selectManipulator(e)}else null===(t=this._selectedSubTool)||void 0===t||t.onManipulatorSelectionChanged()},d.OH),(0,d.wB)(()=>this.view.activeTool,e=>{e!==this&&null!=e&&(this.selectedViewshed=null)}),(0,d.z7)(()=>{const e=this.selectedViewshedComputedData;return null==e?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{const{subTool:t,observer:i,target:s}=e;null!==t&&void 0!==t&&t.moveInteractionState.dragging?this._updateInteractionVisualsLocation(i,!0):(null===t||void 0===t?void 0:t.scaleOrientInteractionState.dragging)&&this._updateInteractionVisualsLocation(s,!1)},d.Vh),(0,d.wB)(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),(0,d.wB)(()=>this.selectedViewshed,e=>{const t=this._selectedManipulator,i=this._selectedSubTool;null==e?this._selectManipulator(null):null!=t&&i.hasManipulator(t)||this._selectManipulator(i.discManipulator)},d.Vh)])}destroy(){this.subToolHandles=(0,l.pR)(this.subToolHandles),this.removeHandles(We)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){var e,t;return null!==(e=null===(t=this.analysisViewData.viewshedComputedDataHandles)||void 0===t?void 0:t.some(e=>e.viewshedComputedData.valid))&&void 0!==e&&e}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(e){var t,i;const s=this._selectedManipulator;s!==e&&(this._selectedManipulator=e,null!=s&&(s.selected=!1),null!=e&&(e.selected=!0),null!==(t=this._findSubTool(s))&&void 0!==t&&t.onManipulatorSelectionChanged(),null===(i=this._selectedSubTool)||void 0===i||i.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(e){this.analysisViewData.selectedViewshed=e}get selectedViewshedComputedData(){var e;return null===(e=this._selectedSubTool)||void 0===e?void 0:e.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(e=>{let{subTool:t}=e;return t.grabbing})}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return"placing-target"===this._creationState}place(e){this.selectedViewshed=null,this._placementMode=e,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(e=>e.subTool.onManipulatorSelectionChanged())}onInputEvent(e){switch(e.type){case"immediate-double-click":this._doubleClickHandler(e);break;case"pointer-move":this._pointerMoveHandler(e);break;case"key-down":Ne.NE.cancel===e.key?this._cancelKeyHandler(e):Ne.NE.delete.includes(e.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(e){"immediate-click"===e.type&&this._clickPlacementHandler(e)}onActivate(){this._placementMode=tt}_clickPlacementHandler(e){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(e,et);if(null!=t){if("placing-observer"===this._creationState){var i;t.mapPoint.z=(null!==(i=t.mapPoint.z)&&void 0!==i?i:0)+1.5;const e=new G.A({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if("placing-target"===this._creationState){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,"multiple"===this._placementMode?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}e.stopPropagation()}}_doubleClickHandler(e){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,e.stopPropagation())}_pointerMoveHandler(e){if(!this.creating)return;const t=this._intersectScreen(e,et);null!=t&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(e){this.creating?this._onCancelWhileCreating(e):this.grabbing||(this.selectedViewshed=null,e.stopPropagation())}_onCancelWhileCreating(e){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,"multiple"===this._placementMode&&e.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),null!=this.selectedViewshed&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(e){const t=this._stagedViewshed,i=this._stagedViewshedComputedData;if(null==t||null==i)return;const{heading:s,tilt:r,farDistance:a}=function(e,t,i){const s=t.observerRenderSpace,r=(0,u.a)($e,i,s),a=(0,u.H)(r)*t.metersPerUnit,n=e.renderCoordsHelper.basisMatrixAtPosition(s,Je),o=(0,u.j)(Ke,n[8],n[9],n[10]),l=(0,S.O_)(s,o,Ye),d=(0,S._I)(l,i,Xe),c=(0,u.a)(d,d,s),h=((0,u.H)(c)<1e-4?90:(0,b.KJ)((0,u.p)(r,c)))*((0,u.f)(o,r)<0?-1:1)+90,v=(0,u.j)(Qe,n[4],n[5],n[6]),p=(0,b.KJ)((0,u.p)(v,c)),w=(0,u.j)(Qe,n[0],n[1],n[2]);return{heading:(0,u.f)(c,w)<0?360-p:p,tilt:h,farDistance:a}}(this.view,i,e);t.farDistance=a,t.tilt=r,t.heading=s}removeStaged(){const e=this._stagedViewshed;return null!=e&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(e),!0)}_intersectScreen(e,t){const i=(0,Ge.sC)(e);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,r=t.scenePoint;if(!s.getIntersectionPoint(r))return null;const a=t.mapPoint;return a.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,a),null==a?null:(t.feature=(0,ke.Gy)(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(We);const e=this._settings.visualElements,t=new je.o({view:this.view,attached:!1,style:{glowWidth:e.heightPlane.glowWidth,innerWidth:e.heightPlane.innerWidth},isDecoration:!0}),i=new Ue.U({view:this.view,extensionType:e.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:4,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:i},this.addHandles([(0,d.wB)(()=>e.zVerticalLine,e=>e.apply(i),d.pc),(0,d.wB)(()=>e.heightPlane,e=>e.apply(t),d.pc),(0,W.hA)(()=>{t.destroy(),i.destroy(),this._interactionVisualElements=null})],We)}updateInteractionVisualsVisibility(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,r=this.selectedViewshedComputedData,a=(e,t)=>{const i=this._interactionVisualElements;null!=i&&(i.verticalLine.attached=t,i.laserline.attached=e)};if(t)return void a(i,!1);if(null==s||null==r)return void a(!1,!1);const n=s.moveInteractionState,o=e?n.grabbing:n.dragging,l=s.scaleOrientInteractionState,d=e?l.grabbing:l.dragging,c=i&&(o||d);if(a(c,o),c){const e=o?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(e,o)}}_updateInteractionVisualsLocation(e,t){const i=this._interactionVisualElements;if(null==i)return;const{laserline:s,verticalLine:r}=i;s.heightManifoldTarget=e,s.intersectsWorldUpAtLocation=t?e:null,null!=e&&r.setStartEndFromWorldDownAtLocation(e)}_findSubTool(e){var t;if(null==e)return null;const i=e instanceof ee.q?t=>t.subTool.hasManipulator(e):t=>t.subTool.viewshed===e;return null===(t=this.subToolHandles)||void 0===t||null===(t=t.find(i))||void 0===t?void 0:t.subTool}get test(){}};(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],qe.prototype,"view",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"analysisViewData",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"removeIncompleteOnCancel",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"automaticManipulatorSelection",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],qe.prototype,"analysis",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"subToolHandles",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"_stagedViewshed",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"_stagedViewshedComputedData",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"_placementMode",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"_creationState",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"_valid",null),(0,s.Cg)([(0,c.MZ)({readOnly:!0})],qe.prototype,"cursor",null),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"_selectedManipulator",void 0),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"_selectedSubTool",null),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"selectedViewshed",null),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"selectedViewshedComputedData",null),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"stagedViewshed",null),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"grabbing",null),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"creating",null),(0,s.Cg)([(0,c.MZ)()],qe.prototype,"isPlacingTarget",null),qe=(0,s.Cg)([(0,h.$)("esri.views.3d.analysis.Viewshed.ViewshedTool")],qe);const $e=(0,v.vt)(),Ke=(0,v.vt)(),Xe=(0,v.vt)(),Qe=(0,v.vt)(),Je=(0,V.vt)(),Ye=(0,S.vt)(),et={mapPoint:new M.A,scenePoint:(0,v.vt)(),feature:null},tt="multiple";var it=i(53084),st=i(32314),rt=i(50468),at=i(17345);class nt extends st.X{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new ge.v((0,y.A)((0,y.A)({},A.shapeMaterialParameters),{},{isDecoration:this.isDecoration,writeDepth:!1})),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){const e=this._viewshedComputedData;if(null==e)return;const t=(0,V.vt)(),i=e.farDistanceRenderSpace;(0,C.CV)(t,(0,v.fA)(i,i,i)),E(e,ut),(0,C.lK)(t,ut,t),(0,C.kN)(ut,this._viewshedComputedData.observerRenderSpace),(0,C.lK)(t,ut,t),this.transform=t}createExternalResources(){}destroyExternalResources(){}forEachMaterial(e){e(this._material)}createGeometries(e){const{_material:t,viewshedComputedData:i}=this;null!=i&&null!=t&&i.valid&&function(e,t){const{horizontalFieldOfView:i,verticalFieldOfView:s}=t,r=(0,u.j)(lt,0,0,1),a=(0,u.j)(dt,0,1,0),n=(0,u.j)(ct,1,0,0);z(r,r,(0,b.kU)(s/2),a),z(r,r,(0,b.kU)(i/2),n);const o=e=>Math.ceil(Math.abs(e)/D)+1,l=(0,b.kU)(i),d=(0,u.d)(ht,n),c=o(l),h=ot(-l/(c-1)),v=(0,C.$0)(ut,h,d),p=(0,b.kU)(-s),w=o(p),g=ot(p/(w-1)),f=(0,u.d)(dt,a),_=(0,C.$0)(vt,(0,b.kU)(i)/2,n);(0,u.t)(f,f,_);const m=vt,V=[],M=(0,u.d)(ct,r);for(let b=0;b<c;b++){(0,C.$0)(m,g,f);for(let e=0;e<w;e++){const t=3*(e*c+b);V[t]=M[0],V[t+1]=M[1],V[t+2]=M[2],(0,u.t)(M,M,m)}(0,u.t)(f,f,v),(0,u.t)(r,r,v),(0,u.d)(M,r)}const y=c*w;V[3*y]=0,V[3*y+1]=0,V[3*y+2]=0;const S=[];for(let u=0;u<c-1;u++)for(let e=0;e<w-1;e++){const t=6*(e*(c-1)+u);S[t]=e*c+u,S[t+1]=(e+1)*c+u,S[t+2]=e*c+u+1,S[t+3]=e*c+u+1,S[t+4]=(e+1)*c+u,S[t+5]=(e+1)*c+u+1}const R=[S];if(360!==i&&0!==s){const e=[],t=[];for(let i=0;i<w-1;i++){const s=3*i;e[s]=y,e[s+1]=(i+1)*c,e[s+2]=i*c,t[s]=y,t[s+1]=i*c+c-1,t[s+2]=(i+1)*c+c-1}R.push(e,t)}if(180!==s&&0!==i){const e=[],t=[];for(let i=0;i<c-1;i++){const s=3*i;e[s]=y,e[s+1]=i,e[s+2]=i+1,t[s]=y,t[s+1]=i+(w-1)*c+1,t[s+2]=i+(w-1)*c}R.push(e,t)}return R.map(t=>{const i=[["position",new rt.n(V,t,3,!0)]];return new at.V(e,i)})}(t,i).forEach(t=>e.addGeometry(t))}}function ot(e){return isNaN(e)?1:e}const lt=(0,v.vt)(),dt=(0,v.vt)(),ct=(0,v.vt)(),ht=(0,v.vt)(),ut=(0,V.vt)(),vt=(0,V.vt)();var pt=i(7256),wt=i(83574),gt=i(35925);let ft=class extends m.A{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:(0,v.vt)(),topRight:(0,v.vt)(),bottomLeft:(0,v.vt)(),bottomRight:(0,v.vt)()},this._arcCenterPoints={top:(0,v.vt)(),bottom:(0,v.vt)(),left:(0,v.vt)(),right:(0,v.vt)()},this._parallelCenters={top:(0,v.vt)(),bottom:(0,v.vt)()}}initialize(){const e={view:this.view,isDecoration:!0},t=(0,y.A)((0,y.A)({},e),{},{color:this._color,renderOccluded:4}),i=(0,y.A)((0,y.A)({},t),{},{stipplePattern:(0,gt.wk)(2)});this._observerVisualElement=new wt.l((0,y.A)((0,y.A)({},e),A.observerPointConfiguration)),this._shapeVisualElement=new nt((0,y.A)((0,y.A)({},e),{},{isDecoration:this.isDecoration})),this._frameLinesVisualElement=new pt.t(t),this._leftArcVisualElement=new pt.t(t),this._rightArcVisualElement=new pt.t(t),this._topArcVisualElement=new pt.t(t),this._bottomArcVisualElement=new pt.t(t),this._centralLongitude=new pt.t(i),this._centralLatitude=new pt.t(i),this.addHandles([(0,d.wB)(()=>{const e=this.viewshedComputedData;if(null===e||void 0===e||!e.valid)return null;const t=this._viewshedCorners,i=this._arcCenterPoints,s=this._parallelCenters;return e.cornerPoints(t),e.arcCentersPoints(i),e.parallelCenterPoints(s),{viewshedComputedData:e,corners:t,arcCenters:i,parallelCenters:s,interactive:this.analysisViewData.interactive,selected:this._selected}},e=>{const t=null!=e;this._forEachVisualElement(e=>e.attached=t),t&&this._updateVisualElements(e)},{initial:!0,equals:it.aI}),(0,d.wB)(()=>{const{viewshedComputedData:e}=this,{horizontalFieldOfView:t,verticalFieldOfView:i}=null!==e&&void 0!==e?e:{};return{viewshedComputedData:e,horizontalFieldOfView:t,verticalFieldOfView:i}},e=>{let{viewshedComputedData:t}=e;const{_shapeVisualElement:i}=this;t!==i.viewshedComputedData&&(i.viewshedComputedData=t),this._shapeVisualElement.recreateGeometry()},d.Vh),(0,d.wB)(()=>{var e;const{interactive:t}=this.analysisViewData;return{visible:this.visible,selected:t&&this._selected,staged:t&&this._staged,horFovNot360:360!==(null===(e=this.viewshedComputedData)||void 0===e?void 0:e.horizontalFieldOfView)}},e=>{let{visible:t,selected:i,staged:s,horFovNot360:r}=e;const a=i||s;this._shapeVisualElement.visible=t,this._topArcVisualElement.visible=t,this._bottomArcVisualElement.visible=t,this._frameLinesVisualElement.visible=t&&r;const n=t&&(i||r);this._leftArcVisualElement.visible=n,this._rightArcVisualElement.visible=n,this._forEachLineVisualElement(e=>{e.width=a?A.frameWidthSelected:A.frameWidthNotSelected,e.renderOccluded=i?4:1}),[this._centralLatitude,this._centralLongitude].forEach(e=>{e.width=2*(a?A.frameWidthSelected:A.frameWidthNotSelected),e.visible=t&&i})},d.Vh),(0,d.wB)(()=>{var e;const{analysisViewData:{interactive:t,tool:i},_selected:s,visible:r}=this,a=this.view.activeTool,n=!(null!==i&&void 0!==i&&i.active)&&a instanceof qe&&a.creating;return{observerVisible:r&&!s&&(!t||null!==(e=null===i||void 0===i?void 0:i.creating)&&void 0!==e&&e||n),color:this._color}},e=>{let{observerVisible:t,color:i}=e;this._observerVisualElement.visible=t,this._forEachLineVisualElement(e=>e.color=i)},d.Vh)])}get _color(){var e,t;const{viewshedComputedData:i,_selected:s,analysisViewData:r}=this;if(null==i)return R.A.toUnitRGBA(A.frameColor);const a=(null===(e=r.tool)||void 0===e?void 0:e.active)||r.interactive,n=i.viewshed===(null===(t=r.tool)||void 0===t?void 0:t.stagedViewshed),o=a&&(s||n)?this.view.effectiveTheme.accentColor:A.frameColor;return R.A.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:e,analysisViewData:{selectedViewshedComputedData:t}}=this;return null!=e&&e===t}get _staged(){const{analysisViewData:{tool:e},viewshedComputedData:t}=this;return null!=e&&e.creating&&e.stagedViewshed===(null===t||void 0===t?void 0:t.viewshed)}destroy(){this._observerVisualElement=(0,l.pR)(this._observerVisualElement),this._shapeVisualElement=(0,l.pR)(this._shapeVisualElement),this._frameLinesVisualElement=(0,l.pR)(this._frameLinesVisualElement),this._leftArcVisualElement=(0,l.pR)(this._leftArcVisualElement),this._rightArcVisualElement=(0,l.pR)(this._rightArcVisualElement),this._topArcVisualElement=(0,l.pR)(this._topArcVisualElement),this._bottomArcVisualElement=(0,l.pR)(this._bottomArcVisualElement),this._centralLongitude=(0,l.pR)(this._centralLongitude),this._centralLatitude=(0,l.pR)(this._centralLatitude)}_forEachLineVisualElement(e){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_forEachVisualElement(e){this._forEachLineVisualElement(e),e(this._observerVisualElement),e(this._shapeVisualElement)}_updateVisualElements(e){const{viewshedComputedData:t,corners:i,arcCenters:s,parallelCenters:r}=e,a=(0,v.o8)(t.observerRenderSpace);this._observerVisualElement.geometry=t.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(a,i),this._updateFrameArcs(t,i,r),this._updateCentralHelperArcs(t,s)}_updateFrameLines(e,t){this._frameLinesVisualElement.geometry=[[e,t.topLeft],[e,t.topRight],[e,t.bottomLeft],[e,t.bottomRight]]}_updateFrameArcs(e,t,i){const{observerRenderSpace:s,rightVector:r,horizontalFieldOfView:a,tiltedUpVector:n}=e,o=(0,b.kU)(a),l=(0,v.vt)(),d=(0,V.vt)();(0,C.$0)(d,o/2,n),(0,u.t)(l,r,d),_t(this._leftArcVisualElement,s,t.bottomLeft,t.topLeft,"forward",l),(0,C.$0)(d,-o/2,n),(0,u.j)(l,0,0,0),(0,u.t)(l,r,d),_t(this._rightArcVisualElement,s,t.bottomRight,t.topRight,"forward",l);const c=a>180?"backward":"forward";_t(this._topArcVisualElement,i.top,t.topRight,t.topLeft,c,n),_t(this._bottomArcVisualElement,i.bottom,t.bottomRight,t.bottomLeft,c,n)}_updateCentralHelperArcs(e,t){const i=e.observerRenderSpace,s=e.horizontalFieldOfView>=180?"backward":"forward";_t(this._centralLatitude,i,t.right,t.left,s,e.tiltedUpVector),_t(this._centralLongitude,i,t.top,t.bottom,"forward",e.leftVector)}get test(){}};function _t(e,t,i,s,r,a){let n=arguments.length>6&&void 0!==arguments[6]?arguments[6]:D;const o=(0,v.vt)();(0,u.a)(o,i,t);const l=(0,u.H)(o),d=(0,v.vt)();(0,u.a)(d,s,t),(0,u.n)(d,d),(0,u.h)(d,d,l);let c=(0,u.p)(o,d);const h=(0,v.o8)(a);"backward"===r&&((0,u.u)(h,h),c=-(2*Math.PI-c));const p=[],w=Math.ceil(Math.abs(c)/n),g=(0,V.vt)();(0,C.$0)(g,c/w,h);const f=(0,v.vt)();(0,u.d)(f,o);const _=(0,v.vt)();(0,u.d)(_,i);for(let m=0;m<w;m++){const e=(0,v.vt)();(0,u.d)(e,_),(0,u.t)(f,f,g),(0,u.g)(_,t,f);const i=(0,v.vt)();(0,u.d)(i,_),p.push([e,i])}e.geometry=p}(0,s.Cg)([(0,c.MZ)()],ft.prototype,"view",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],ft.prototype,"isDecoration",void 0),(0,s.Cg)([(0,c.MZ)()],ft.prototype,"analysisViewData",void 0),(0,s.Cg)([(0,c.MZ)()],ft.prototype,"viewshedComputedData",void 0),(0,s.Cg)([(0,c.MZ)()],ft.prototype,"visible",void 0),(0,s.Cg)([(0,c.MZ)()],ft.prototype,"_color",null),(0,s.Cg)([(0,c.MZ)()],ft.prototype,"_selected",null),(0,s.Cg)([(0,c.MZ)()],ft.prototype,"_staged",null),ft=(0,s.Cg)([(0,h.$)("esri.views.3d.analysis.Viewshed.ViewshedSubVisualization")],ft);let mt=class extends m.A{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,t=(0,o.L)(()=>this.analysisViewData.viewshedComputedDataHandles,t=>{let{viewshedComputedData:i}=t;const s=new ft({view:this.view,viewshedComputedData:i,analysisViewData:e,isDecoration:this.isDecoration});return{visualization:s,remove:()=>s.destroy()}});this._subVisualizations=t,this.addHandles([(0,W.DQ)(t),(0,d.wB)(()=>this.visible,e=>this._subVisualizations.forEach(t=>{let{visualization:i}=t;return i.visible=e}),d.Vh)])}get test(){}};(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],mt.prototype,"analysisViewData",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0,nonNullable:!0})],mt.prototype,"view",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0})],mt.prototype,"isDecoration",void 0),(0,s.Cg)([(0,c.MZ)()],mt.prototype,"visible",null),mt=(0,s.Cg)([(0,h.$)("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],mt);var bt=i(96342),Vt=i(19276),Mt=i(78315),yt=i(90364),Ct=i(36451),St=i(81330),Rt=i(55855),Dt=i(33062);let Ot=class extends Dt.A{constructor(){super(...arguments),this.sectionAngles=(0,Rt.vt)()}get sectionAnglesDeg(){return(0,Rt.ci)(this.sectionAngles.map(e=>(0,b.KJ)(e)))}set sectionAnglesDeg(e){this.sectionAngles=(0,Rt.ci)(e.map(e=>(0,b.kU)(e)))}get projectionMatrix(){return(0,C.lK)((0,V.vt)(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const e=this.sectionAngles[0],t=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];(0,re.vA)(e<=t),(0,re.vA)(i<=s);const r=2*Math.tan(this.fovX/2),a=2*Math.tan(this.fovY/2),n=Math.tan(e),o=Math.tan(t),l=Math.tan(i),d=o-n,c=Math.tan(s)-l,h=r/d,u=a/c,v=-(n+d/2)/r*2,p=-(l+c/2)/a*2,w=(0,V.vt)();(0,C.kN)(w,[v,p,0]);const g=(0,V.vt)();(0,C.CV)(g,[h,u,1]);const f=(0,V.vt)();return(0,C.lK)(f,g,w)}get _sectionRatioX(){const e=Math.tan(this.sectionAngles[0]),t=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(t-e)/i)}setViewport(e,t){const i=t*this._sectionRatioX;return this.viewport=[e[0],e[1],i,t],i}};(0,s.Cg)([(0,c.MZ)()],Ot.prototype,"sectionAngles",void 0),(0,s.Cg)([(0,c.MZ)()],Ot.prototype,"sectionAnglesDeg",null),(0,s.Cg)([(0,c.MZ)()],Ot.prototype,"projectionMatrix",null),(0,s.Cg)([(0,c.MZ)()],Ot.prototype,"sectionMatrix",null),(0,s.Cg)([(0,c.MZ)()],Ot.prototype,"_sectionRatioX",null),Ot=(0,s.Cg)([(0,h.$)("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Ot);var At=i(93345),Tt=i(82751);class xt{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){const t=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*t}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}}const Ft=["front","left","right","back","top","bottom"];class Pt{constructor(e){this._fbos=e,this._faces={},this._width=0,this._height=0,this.settings=new xt,this._maxTextureSize=Math.min((0,a.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){var e;return null===(e=this._handle)||void 0===e?void 0:e.getTexture(At.nI)}get ready(){return null!=this.depthTexture&&0!==this._width&&0!==this._height}get nearFar(){const e=this.faces;return 0===e.length?null:e[0].nearFar}get numActiveFaces(){const e=this._faces;let t=0;return Object.keys(e).forEach(i=>{e[i]&&(t+=1)}),t}get faces(){const e=this._faces,t=[];for(const i of Ft){const s=e[i];s&&t.push(s)}return t}get atlasRegions(){return this.faces.map(e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,t,i,s){const{effectiveObserverRenderSpace:r,tiltedUpVector:a,targetRenderSpace:n,farDistanceRenderSpace:o,horizontalFieldOfView:l,verticalFieldOfView:d}=t,c=(0,v.vt)();(0,u.a)(c,n,r);const h=(0,v.vt)(),p=(0,v.vt)(),w=(e,t)=>{const i=(0,v.vt)(),s=(0,V.vt)();return(0,C.$0)(s,e,t),(0,u.t)(i,c,s),(0,u.g)(i,r,i),i};let g,f=a;const _=Math.min(90,l),m=Math.min(90,Math.max(0,(l-90)/2));let M=-45,y=45,S=-45,R=45;if(function(e){return!["top","bottom"].includes(e)}(e)){const e=e=>(0,b.qE)(e,-45,45);S=e(-d/2)-this.settings.toleranceBottomTop,R=e(+d/2)+this.settings.toleranceBottomTop}switch(e){case"front":g=n,M=-_/2,y=_/2;break;case"left":g=w(Math.PI/2,a),M=45-m;break;case"right":g=w(-Math.PI/2,a),y=-45+m;break;case"top":g=(0,u.g)(h,r,a),f=(0,u.u)(p,c);break;case"bottom":g=(0,u.a)(h,r,a),f=c;break;case"back":g=w(Math.PI,a)}const D=new Ot({center:g,eye:r,up:f,far:o});D.sectionAnglesDeg=[M-this.settings.toleranceSides,y+this.settings.toleranceSides,S,R],D.fovY=Math.PI/2;const O=D.setViewport(i,s);return this._faces[e]=D,O}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){const t=new Set,{horizontalFieldOfView:i,verticalFieldOfView:s}=e,r=-s/2,a=s/2;return 0===i||0===s||(r<=45&&a>=-45&&t.add("front"),i>90&&(t.add("left"),t.add("right")),i>270&&t.add("back"),a>45-this.settings.toleranceBottomTop&&t.add("top"),r<-45+this.settings.toleranceBottomTop&&t.add("bottom")),t}_computeBaseTextureSize(e,t,i,s){let{pixelRatio:r,fullWidth:a,fullHeight:n}=e;const o=t/r,l=this.settings.textureSizeModifier(i);return(0,St.Mv)(Math.max(a,n)*o*l,this._maxTextureSize/s)}_ensureFBO(e){var t,i,s,r;const a=this._width,n=this._height,o=null===(t=this._handle)||void 0===t?void 0:t.fbo;o&&o.width===a&&o.height===n&&e===(0,Tt.QJ)(null!==(i=null===(s=o.depthStencilTexture)||void 0===s||null===(s=s.descriptor)||void 0===s?void 0:s.internalFormat)&&void 0!==i?i:At.SB.DEPTH_COMPONENT16)||(null!==(r=this._handle)&&void 0!==r&&r.release(),this._handle=this._allocateFBO(e))}_allocateFBO(e){var t;const{_width:i,_height:s}=this,r=e?13:12,a=this._fbos.acquire(i,s,"viewshed shadow map",r);return null!==(t=a.getTexture(At.nI))&&void 0!==t&&t.setShadowFiltering(!1),a}clearFBO(e){var t;const i=this._fbos.rctx;this._ensureFBO(e),i.bindFramebuffer(null===(t=this._handle)||void 0===t?void 0:t.fbo),i.setClearColor(1,1,1,1),i.clear(16640)}dispose(){this._debugFBO||(this._handle=(0,l.Gz)(this._handle))}start(e,t,i,s){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this._faces={};const a=this._computeActiveFaces(t),n=a.size;if(0===n)return!1;const o=this._computeBaseTextureSize(e,s,i,n);let l=0,d=0,c=0;return Ft.filter(e=>a.has(e)).forEach(e=>{const i=function(e,t){if(t<4)return 0;const i="front"===e||"left"===e;return 4===t?i?0:1:i||"right"===e?0:1}(e,n);i>d&&(c=Math.max(c,l),l=0),d=i;const s=i*o;l+=this._setupFaceCamera(e,t,[l,s],o)}),c=Math.max(c,l),this._width=this.settings.textureResizeModulo(c),this._height=function(e){return e<4?1:2}(n)*o,this.clearFBO(r),!0}finish(){}get test(){}}var Et=i(27456),Ht=i(16506),zt=i(59246),Zt=i(11850),It=i(57162);class Ut extends zt.w{constructor(e,t){super(e,t,new Ht.$(Et.a,()=>i.e(8758).then(i.bind(i,28758))),Zt.Nx)}initializePipeline(){return(0,It.Ey)({colorWrite:It.kn,blending:It.T8})}}let jt=class extends Ct.A{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(e=>function(e,t){const i=(0,Mt.j)(t.observerRenderSpace,t.farDistanceRenderSpace);return!!e.ready&&e.frustum.intersectsSphere(i)}(this.view,e))}constructor(e){super(e),this.isDecoration=!1,this._passParameters=new Et.V,this._viewsheds=new Vt.A,this._shadowMap=null,this.consumes={required:[yt.OG.VIEWSHED,"normals"]},this.produces=yt.OG.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new Pt(this.fboCache),this.addHandles([(0,d.wB)(()=>this.view.resolutionScale,e=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=e)},d.Vh),(0,d.z7)(()=>!this.hasViewsheds,()=>{var e;return null===(e=this._shadowMap)||void 0===e?void 0:e.dispose()}),(0,d.wB)(()=>this._viewshedsInView.map(e=>[e.observerRenderSpace,e.heading,e.tilt,e.farDistance,e.horizontalFieldOfView,e.verticalFieldOfView]),()=>this.requestRender(1),d.OH)])}destroy(){this._shadowMap=(0,l.WD)(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(Ut);for(const t of this._viewshedsInView){var e;if(null!==(e=this._shadowMap)&&void 0!==e&&e.isActive(t))return void this.view.stage.renderer.precompileViewshedShadowMap()}}}render(e){var t,i,s;const r=this.bindParameters,a=this.renderingContext,n=e.find(e=>{let{name:t}=e;return t===yt.OG.VIEWSHED});if(!this.hasViewsheds||!r.depth||this.isDecoration&&!r.decorations)return n;this._passParameters.shadowMap=null!==(t=this._shadowMap)&&void 0!==t?t:this._passParameters.shadowMap,this._passParameters.normals=null===(i=e.find(e=>{let{name:t}=e;return"normals"===t}))||void 0===i?void 0:i.getTexture();const o=this.techniques.get(Ut);if(null===o||void 0===o||!o.compiled)return this.requestRender(1),n;const l=this.view.stage.renderer.isFeatureEnabled(7);for(const c of this._viewshedsInView){var d;if(!this._renderShadowCubeMap(r,c,l)||null===(d=this._shadowMap)||void 0===d||!d.ready)continue;const e=this._setupViewshedParameters(c,r.camera);a.bindTechnique(o,r,e),a.bindFramebuffer(n.fbo),a.screen.draw()}return null!==(s=this.shadowMap)&&void 0!==s&&s.dispose(),n}updateViewsheds(e){const t=this._viewsheds,{removes:i,adds:s}=e;if(i&&(Array.isArray(i)?t.removeMany(i):t.remove(i)),s)if(Array.isArray(s)){const e=s.filter(e=>!t.includes(e));t.addMany(e)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(e,t,i){const s=this._shadowMap;if(!s)return!1;const r=this.view.basemapTerrain.hasStencilEnabledExtents,a=s.start(e.camera,t,i,this._contentPixelRatio,r);return a&&s.faces.forEach(e=>this.view.stage.renderer.renderViewshedShadowMap(e)),s.finish(),a}_setupViewshedParameters(e,t){var i;const s=this._shadowMap;if(!s)return this._passParameters;const r=this._passParameters,a=e.effectiveObserverRenderSpace;r.localOrigin=a,r.observerOffset=(0,u.a)(Lt,e.observerRenderSpace,e.effectiveObserverRenderSpace),r.fovs=[(0,b.kU)(e.horizontalFieldOfView),(0,b.kU)(e.verticalFieldOfView)],r.headingAndTilt=[(0,b.kU)(e.heading),(0,b.kU)(e.tiltParallelToSurface)],r.upVector=e.tiltedUpVector;const n=function(e,t){const i=(0,v.vt)();return(0,u.a)(i,e,t)}(e.targetRenderSpace,a);r.targetVector=n;const o=new Array,l=new Array;for(let d=0;d<s.numActiveFaces;d++)(0,C.Tl)(Nt,s.viewshedViewMatrices[d],a),o.push(...Nt),kt(s.viewshedProjectionMatrices[d],Nt,Bt),l.push(...Bt);return r.viewMatrices=o,r.projectionMatrices=l,r.volumeOffset=(null===(i=this.selectedViewshed)||void 0===i?void 0:i.call(this))===e.viewshed?function(e,t,i){if(null==e)return 0;const{observerRenderSpace:s,targetRenderSpace:r}=e,a=(0,u.k)(i,s)>(0,u.k)(i,r)?e.observer:e.target;return t.pixelSizeAt(a)}(e,this.view,t.eye):0,r}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function kt(e,t,i){const s=(0,v.fA)(.5,.5,.5);return(0,C.kN)(i,s),(0,C.hs)(i,i,s),(0,C.lK)(i,i,e),(0,C.lK)(i,i,t),i}(0,s.Cg)([(0,c.MZ)()],jt.prototype,"selectedViewshed",void 0),(0,s.Cg)([(0,c.MZ)()],jt.prototype,"isDecoration",void 0),(0,s.Cg)([(0,c.MZ)()],jt.prototype,"shadowMap",null),(0,s.Cg)([(0,c.MZ)()],jt.prototype,"hasViewsheds",null),(0,s.Cg)([(0,c.MZ)()],jt.prototype,"_contentPixelRatio",null),(0,s.Cg)([(0,c.MZ)()],jt.prototype,"_viewshedsInView",null),(0,s.Cg)([(0,c.MZ)()],jt.prototype,"consumes",void 0),(0,s.Cg)([(0,c.MZ)()],jt.prototype,"produces",void 0),jt=(0,s.Cg)([(0,h.$)("esri.views.3d.webgl-engine.lib.Viewshed")],jt);const Lt=(0,v.vt)(),Nt=(0,V.vt)(),Bt=(0,V.vt)();var Gt=i(10260);let Wt=class extends f.P{constructor(e){super(e),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderNode=null,this._intersector=null}get visible(){return super.visible}set visible(e){super.visible=e}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(e){this._unselectOtherViewsheds(e),this._selectedViewshed=e}get selectedViewshedComputedData(){var e;return null===(e=this.tool)||void 0===e?void 0:e.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const e=this.view;this._viewshedRenderNode=new jt({view:e,selectedViewshed:()=>{var e,t;return null!==(e=this.selectedViewshed)&&void 0!==e?e:null===(t=this.tool)||void 0===t?void 0:t.stagedViewshed},isDecoration:this._isDecoration}),this._intersector=new bt.n(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=0,this.viewshedComputedDataHandles=(0,o.L)(()=>this.analysis.viewsheds,t=>{const i=new N({renderCoordsHelper:e.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([(0,d.wB)(()=>{var e;return{valid:i.valid,canProject:(0,p.canProjectWithoutEngine)(null===(e=i.observer)||void 0===e?void 0:e.spatialReference,this.view.spatialReference)||(0,p.isLoaded)()}},(e,t)=>{let{valid:s,canProject:r}=e;this.visible&&(s&&r?this._addViewshedsToRenderer(i):(null===t||void 0===t?void 0:t.valid)&&(null===t||void 0===t?void 0:t.canProject)&&this._removeViewshedsFromRenderer(i),r||(0,_.V)(this.analysis,i.observer.spatialReference,n.A.getLogger(this)))},d.Vh),...this._createFeatureReferenceHandles(i)],s),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}}),this._visualization=new mt({view:e,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([(0,d.wB)(()=>this.visible,e=>{const t=this.viewshedComputedDataHandles;if(null==t)return;e||(this.selectedViewshed=null);const i=t.map(e=>e.viewshedComputedData).filter(e=>e.valid).toArray();e?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)}),(0,d.wB)(()=>e.renderCoordsHelper,e=>{var t;null===(t=this.viewshedComputedDataHandles)||void 0===t||t.forEach(t=>{let{viewshedComputedData:i}=t;return i.renderCoordsHelper=e})}),(0,Gt.Hd)(this,qe),(0,d.z7)(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},d.pc)])}destroy(){this.userOperation=(0,l.DC)(this.userOperation),(0,Gt.aS)(this),this._visualization=(0,l.pR)(this._visualization);const e=this.viewshedComputedDataHandles;null!=e&&this._removeViewshedsFromRenderer(e.map(e=>e.viewshedComputedData).toArray())}_createFeatureReferenceHandles(e){const{view:t}=this;return[(0,d.wB)(()=>[t.state.camera,t.slice.plane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature],()=>{this._updateObserverFromFeature(t,e)},d.Vh),this._createElevationUpdateHandle(e),(0,d.z7)(()=>e.needUpdateByFeature,()=>{this._updateObserverFromFeature(t,e),e.needUpdateByFeature=!1})]}_createElevationUpdateHandle(e){const t=(i,s)=>{const{view:r}=this,{observer:a}=e;if(null==a)return;const n=(0,p.projectOrLoad)(a,r.spatialReference);if(null!=n.pending)return void n.pending.finally(()=>t(i,s));const o=n.geometry;null!=o&&((0,w.S)(i,s,$t,r.spatialReference),(0,g.Uc)($t,[o.x,o.y])&&(e.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",e=>{let{extent:i,spatialReference:s}=e;return t(i,s)})}async createViewsheds(e){await(0,Gt.ZX)(this,{placementOptions:e,onToolActivated:e=>e.place("multiple")})}place(e){return(0,Gt.ZX)(this,{placementOptions:e,onToolActivated:e=>e.place("single")})}_addViewshedsToRenderer(e){this._viewshedRenderNode.updateViewsheds({adds:e})}_removeViewshedsFromRenderer(e){this._viewshedRenderNode.updateViewsheds({removes:e})}_updateObserverFromFeature(e,t){const i=t.observerRenderSpace,s=t.targetRenderSpace,a=(0,u.d)((0,v.vt)(),i),n={observer:i,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:(0,r.wY)(t.feature),target:s,targetSurfaceNormal:null,targetAdjusted:(0,u.d)((0,v.vt)(),s),targetFeatureId:null};(0,r.uY)(e,this._intersector,n,e=>Math.min(e,.05*t.farDistanceRenderSpace)),t.observerRenderSpaceOverride=(0,u.q)(a,i)?null:a}_unselectOtherViewsheds(e){if(null!=e)for(const t of this.view.tools.items)t!==this.tool&&t instanceof qe&&(t.analysisViewData.selectedViewshed=null)}get test(){}};(0,s.Cg)([(0,c.MZ)({readOnly:!0})],Wt.prototype,"type",void 0),(0,s.Cg)([(0,c.MZ)({constructOnly:!0,nonNullable:!0})],Wt.prototype,"analysis",void 0),(0,s.Cg)([(0,c.MZ)()],Wt.prototype,"tool",void 0),(0,s.Cg)([(0,c.MZ)()],Wt.prototype,"_selectedViewshed",void 0),(0,s.Cg)([(0,c.MZ)()],Wt.prototype,"selectedViewshed",null),(0,s.Cg)([(0,c.MZ)()],Wt.prototype,"selectedViewshedComputedData",null),(0,s.Cg)([(0,c.MZ)()],Wt.prototype,"viewshedComputedDataHandles",void 0),(0,s.Cg)([(0,c.MZ)()],Wt.prototype,"userOperation",void 0),(0,s.Cg)([(0,c.MZ)()],Wt.prototype,"_visualization",void 0),(0,s.Cg)([(0,c.MZ)()],Wt.prototype,"_viewshedRenderNode",void 0),Wt=(0,s.Cg)([(0,h.$)("esri.views.3d.analysis.ViewshedAnalysisView3D")],Wt);const qt=Wt,$t=(0,g.Ie)()},85746:(e,t,i)=>{i.d(t,{X:()=>w});var s=i(6326),r=i(91967),a=i(5632),n=i(46053),o=(i(81806),i(76460),i(47249),i(87990));class l{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1,this._renderGroup=2}destroy(){this._destroyResources()}get resources(){var e;return null===(e=this._resources)||void 0===e?void 0:e.external}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncGeometriesToRenderer())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}get renderGroup(){return this._renderGroup}set renderGroup(e){var t;this._renderGroup=e;const i=null===(t=this._resources)||void 0===t?void 0:t.layerView;i&&(i.renderGroup=e)}recreate(){this.attached&&this._createResources()}recreateGeometry(){this._resourceFactory.recreateGeometry?null!=this._resources&&(this._ensureRenderGeometriesRemoved(),this._resourceFactory.recreateGeometry(this._resources.external),this._syncGeometriesToRenderer()):this.recreate()}forEachMaterial(e){this._resources&&this._resourceFactory.forEachMaterial(this._resources.external,e)}_createOrDestroyResources(){this._attached?null==this._resources&&this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory.createResources(),t=new d({view:this._resourceFactory.view,renderGroup:this._renderGroup}),i=this._resourceFactory.view.overlayManager;this._resources={layerView:t,external:e,geometriesAdded:!1},i&&(this._resources.drapeSourceRenderer=i.registerGeometryDrapeSource(t)),this._syncGeometriesToRenderer()}_destroyResources(){if(null==this._resources)return;this._ensureRenderGeometriesRemoved();const e=this._resourceFactory.view.overlayManager;e&&e.unregisterDrapeSource(this._resources.layerView),this._resourceFactory.destroyResources(this._resources.external),this._resources=null}_syncGeometriesToRenderer(){this._visible?this._ensureRenderGeometriesAdded():this._ensureRenderGeometriesRemoved()}_ensureRenderGeometriesRemoved(){var e;null!=(null===(e=this._resources)||void 0===e?void 0:e.drapeSourceRenderer)&&this._resources.geometriesAdded&&(this._resources.drapeSourceRenderer.removeGeometries(this._resources.external.geometries,1),this._resources.geometriesAdded=!1)}_ensureRenderGeometriesAdded(){var e;null!=(null===(e=this._resources)||void 0===e?void 0:e.drapeSourceRenderer)&&(this._resources.geometriesAdded||(this._resources.drapeSourceRenderer.addGeometries(this._resources.external.geometries,1),this._resources.geometriesAdded=!0))}}let d=class extends((0,a.sA)(r.A)){constructor(e){super(e),this.drapeSourceType=1,this.updatePolicy=1,this.renderGroup=2}};(0,s.Cg)([(0,n.MZ)({constructOnly:!0})],d.prototype,"view",void 0),(0,s.Cg)([(0,n.MZ)({readOnly:!0})],d.prototype,"drapeSourceType",void 0),(0,s.Cg)([(0,n.MZ)()],d.prototype,"renderGroup",void 0),d=(0,s.Cg)([(0,o.$)("esri.views.3d.interactive.visualElements.DrapedVisualElementResources")],d);var c=i(69230),h=i(68134),u=i(37046),v=i(8918);class p{constructor(e){this._resourceFactory=e,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return null!=this._resources?this._resources.object:null}get resources(){return null!=this._resources?this._resources.external:null}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this._syncVisible())}get attached(){return this._attached}set attached(e){e!==this._attached&&(this._attached=e,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this._resourceFactory.recreateGeometry)return void this.recreate();const e=this._resourceFactory.view.stage;if(null==this._resources||!e)return;const t=this._resources.object;t.removeAllGeometries(),this._resourceFactory.recreateGeometry(this._resources.external,t,this._resources.layer)}forEachMaterial(e){this._resources&&this._resourceFactory.forEachMaterial(this._resources.external,e)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const e=this._resourceFactory,t=e.view,i=t.stage;if(!i)return;const s=new v.x(i,{pickable:!1,updatePolicy:1}),r=new u.B({castShadow:!1}),a=e.createResources(r,s);s.add(r);const n=e.cameraChanged,o=n?(0,h.wB)(()=>t.state.camera,e=>n(e),h.Vh):null;this._resources={layer:s,object:r,external:a,cameraHandle:o},this._syncVisible()}_destroyResources(){var e;null!=this._resources&&(this._resources.layer.destroy(),this._resources.object.dispose(),null!==(e=this._resources.cameraHandle)&&void 0!==e&&e.remove(),this._resourceFactory.destroyResources(this._resources.external),this._resources=null)}_syncVisible(){null!=this._resources&&(this._resources.object.visible=this._visible)}}class w extends c.B{constructor(e){var t;super(e),this._isDraped=!1,this.object3dResources=new p(this.createObject3DResourceFactory(e.view)),this.drapedResources=new l(this.createDrapedResourceFactory(e.view)),this.isDraped=null!==(t=e.isDraped)&&void 0!==t&&t}get isDraped(){return this._isDraped}set isDraped(e){e!==this._isDraped&&(this._isDraped=e,this.object3dResources.attached=this.attached&&!e,this.drapedResources.attached=this.attached&&e)}get renderGroup(){return this.drapedResources.renderGroup}set renderGroup(e){this.drapedResources.renderGroup=e}createResources(){this.object3dResources.attached=!this._isDraped,this.drapedResources.attached=this._isDraped}destroyResources(){this.object3dResources.attached=!1,this.drapedResources.attached=!1}recreate(){this.object3dResources.recreate(),this.drapedResources.recreate()}recreateGeometry(){this.object3dResources.recreateGeometry(),this.drapedResources.recreateGeometry()}destroy(){this.object3dResources.destroy(),this.drapedResources.destroy(),super.destroy()}updateVisibility(e){this.object3dResources.visible=e,this.drapedResources.visible=e}forEachMaterial(e){var t,i;null!==(t=this.object3dResources)&&void 0!==t&&t.forEachMaterial(e),null===(i=this.drapedResources)||void 0===i||i.forEachMaterial(e)}}},93131:(e,t,i)=>{i.d(t,{Bw:()=>g,D9:()=>y,DG:()=>h,E3:()=>D,FF:()=>l,Hb:()=>a,I4:()=>V,Jj:()=>R,Ll:()=>v,NT:()=>f,Sw:()=>A,UF:()=>o,YG:()=>S,ZR:()=>p,aE:()=>T,aj:()=>C,c1:()=>c,cE:()=>d,cO:()=>w,lS:()=>u,qD:()=>_,rb:()=>m,sd:()=>O,vA:()=>M,vo:()=>n,xj:()=>b});var s=i(81806),r=i(15941);const a=(0,s.A)("mac")?"Meta":"Control",n="Shift",o=2,l=1.15,d=1.15,c=2500,h=.02,u=Math.cos((0,r.kU)(45)),v=Math.cos((0,r.kU)(5)),p=.95,w=.3,g=2,f=1,_=3,m=11,b=22.5,V=40,M=48,y=2.25,C=4,S=1,R=.3,D=6,O=4,A=1600,T=.4}}]);
//# sourceMappingURL=5595.647db034.chunk.js.map