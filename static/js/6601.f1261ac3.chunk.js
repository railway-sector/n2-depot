"use strict";(self.webpackChunkn2_depot=self.webpackChunkn2_depot||[]).push([[6601],{21877:(e,t,i)=>{i.d(t,{r:()=>m});var s=i(6326),r=i(69539),a=i(91967),n=i(18690),l=i(54901),o=i(68134),h=i(46053),d=(i(81806),i(76460),i(87990)),u=i(56611),p=i(64519),g=i(86875),c=i(7246),w=i(76940),y=i(19276),v=i(85632);let m=class extends a.A{get updating(){var e,t;return null!==(e=null===(t=this.graphicsView)||void 0===t?void 0:t.updating)&&void 0!==e&&e}constructor(e){super(e),this._highlightCounts=new Map,this._graphicsViewLoader=null,this.graphics=new p.Y,this.graphicsView=null,this.suspended=!1;const t=new r.A([255,255,255,1/255]);this._symbols=new Map([["point",new w.A({size:"2px",style:"square",color:t})],["polyline",new c.A({width:"2px",color:t})],["polygon",new g.A({outline:null,color:t})]])}highlight(e,t){const i=function(e){var t,i,s;if(!e)return[];let r=(0,v.DU)(e)?[e]:y.A.isCollection(e)?e.toArray():Array.isArray(e)?e:[];return r=null===(t=r)||void 0===t?void 0:t.filter(n.Ru),0===(null!==(i=null===(s=r)||void 0===s?void 0:s.length)&&void 0!==i?i:0)?[]:r}(e);if(0===i.length)return(0,l.hA)();let s,r=!1;return this.updatingHandles.addPromise(Promise.all([this._createHighlightGraphics(i),this._ensureGraphicsView3D()]).then(e=>{let[i,a]=e;!r&&a&&(s=this._addHighlightGraphics(a,i,t))})),(0,l.hA)(()=>{var e;r=!0,null===(e=s)||void 0===e||e.remove()})}preload(){this._ensureGraphicsView3D()}_addHighlightGraphics(e,t,i){for(const a of t){var s;this._highlightCounts.set(a,(null!==(s=this._highlightCounts.get(a))&&void 0!==s?s:0)+1)}this.graphics.addMany(t);const r=e.highlight(t,i);return(0,l.hA)(()=>{this._removeHighlightGraphics(t),r.remove()})}_removeHighlightGraphics(e){this.graphics.removeMany(e.filter(e=>{var t;const i=Math.max(0,(null!==(t=this._highlightCounts.get(e))&&void 0!==t?t:0)-1);return 0===i?(this._highlightCounts.delete(e),!0):(this._highlightCounts.set(e,i),!1)}))}async _ensureGraphicsView3D(){if(this.graphicsView)return this.graphicsView;this._graphicsViewLoader||(this._graphicsViewLoader=Promise.all([i.e(3263),i.e(3046),i.e(4207)]).then(i.bind(i,14207)));const{default:e}=await this._graphicsViewLoader;if(this.destroyed)return null;const t=new e({view:this.view,layer:{type:"graphics-view-3d-dummy",id:this.layer.id,uid:this.layer.uid,elevationInfo:{mode:"on-the-ground"}},getGraphics:()=>this.graphics,drapeSourcePriorityOffset:.5});return this._set("graphicsView",t),this.addHandles([(0,l.DQ)(this.graphicsView),(0,o.wB)(()=>this.suspended,e=>{t.suspended=e},o.pc)]),t}async _createHighlightGraphics(e){const t=e.map(e=>{let{geometry:t}=e;return null===t||void 0===t?void 0:t.spatialReference}).filter(n.Ru).reduce((e,t)=>{var i;return 0!==e.length&&null!==(i=e.at(-1))&&void 0!==i&&i.equals(t)||e.push(t),e},[]),i=this.view.spatialReference,s=t.map(e=>({source:e,dest:i}));try{await(0,u.initializeProjection)(s)}catch(r){return[]}return e.map(e=>{const{geometry:t}=e;try{const s=t?(0,u.project)(t,i):null,r=e.cloneShallow();return r.geometry=s,r.symbol=this._symbols.get(null===s||void 0===s?void 0:s.type),r}catch(s){return e}})}};(0,s.Cg)([(0,h.MZ)()],m.prototype,"graphics",void 0),(0,s.Cg)([(0,h.MZ)()],m.prototype,"graphicsView",void 0),(0,s.Cg)([(0,h.MZ)()],m.prototype,"view",void 0),(0,s.Cg)([(0,h.MZ)()],m.prototype,"layer",void 0),(0,s.Cg)([(0,h.MZ)()],m.prototype,"updatingHandles",void 0),(0,s.Cg)([(0,h.MZ)()],m.prototype,"suspended",void 0),(0,s.Cg)([(0,h.MZ)()],m.prototype,"updating",null),m=(0,s.Cg)([(0,d.$)("esri.views.3d.layers.support.ImageHighlightHelper3D")],m)},26601:(e,t,i)=>{i.r(t),i.d(t,{default:()=>A});var s=i(6326),r=i(54901),a=i(68134),n=i(46053),l=(i(81806),i(76460),i(47249),i(87990)),o=i(98774),h=i(50346),d=i(50076),u=i(44882);let p=class extends u.A{constructor(e){super(e),this.redrawDebounced=(0,h.sg)(async e=>{this.redraw((e,t)=>this._redrawImage(e,t),e)},2e3)}initialize(){this.addHandles([(0,a.z7)(()=>this.view.basemapTerrain.ready,()=>this._initializeMaximumDataResolution(),{once:!0,initial:!0}),this.layer.on("redraw",()=>this.updatingHandles.addPromise(this.redrawDebounced()))])}_initializeMaximumDataResolution(){this.maximumDataResolution=this.layer.loaded?this.layer.serviceRasterInfo.pixelSize:null}async processResult(e,t,i){t.imageOrCanvasElement?e.image=t.imageOrCanvasElement:(e.image=document.createElement("canvas"),e.pixelData=t.pixelData,await this._redrawImage(e,i))}async _redrawImage(e,t){if(!(e.image instanceof HTMLCanvasElement)||null==e.pixelData)throw new Error;const i=e.image,s=i.getContext("2d"),r=await this.layer.applyRenderer(e.pixelData,{signal:t}),a=this.layer.applyFilter(r).pixelBlock;if(null==a)throw new Error;i.width=a.width,i.height=a.height;const n=s.createImageData(a.width,a.height);n.data.set(a.getAsRGBA()),s.putImageData(n,0,0)}};p=(0,s.Cg)([(0,l.$)("esri.views.3d.layers.ImagerySubView3D")],p);var g=i(21877),c=i(46533),w=i(28701);let y=class extends w.A{constructor(e){super(e)}initialize(){this.updatingHandles.add(()=>this.renderedTiles,()=>this.triggerLoad()),this.updatingHandles.add(()=>this.elevationInfo.mode,e=>this._updatePopupDrapeSource(e),{initial:!0})}_updatePopupDrapeSource(e){if("on-the-ground"===e)return void this.removeHandles(v);if(this.hasHandles(v))return;const t={destroyed:!1,drapeSourceType:2,updatePolicy:0,layer:this.layer},i=this.layerView.view.overlayManager;i.registerGeometryDrapeSource(t),this.addHandles((0,r.hA)(()=>i.unregisterDrapeSource(t)),v)}async fetchDataAndGenerateStreamlines(e,t){const{needsMagnitude:i,workerHandle:s}=this,r=this.getSimulationSettings(e),{size:a,extent:n,timeExtent:l}=e;if(null==r||null==s)return;const o=await(0,c.pH)(this.layer,n,a[0],a[1],l,t);if(null==o)return null;const h={simulationSettings:r,flowExtentInfo:e.flowExtentInfo,flowData:o,needsMagnitude:i,startPositions:this.startPositions(e)},{streamlines:d}=await s.generateStreamlines(h,t);return d}};y=(0,s.Cg)([(0,l.$)("esri.views.3d.support.flow.FlowSubViewExtent3D")],y);const v=Symbol("popupDrapeSource");var m=i(19247),f=i(1900),_=i(51939),x=i(31516),D=i(59844),H=i(97015),C=i(2257);const V=e=>{const t=e;let i=class extends t{constructor(){super(...arguments),this.view=null}get timeExtent(){var e;return(0,x.F)(this.layer,null===(e=this.view)||void 0===e?void 0:e.timeExtent,this._get("timeExtent"))}async fetchPopupFeaturesAtLocation(e,t){const{layer:i}=this;if(!e)throw new d.A("imagerylayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const{popupEnabled:s}=i,r=(0,C.D8)(i,t);if(!s||null==r)return[];const a=await r.getRequiredFields(null,{index:new f.A(i.rasterFields),partitions:new Map([["$pixel",i.rasterFields.filter(e=>e.name.startsWith(_.ER)).map(e=>e.name)],["$imageCollectionItem",i.fields.map(e=>e.name)]])});(0,h.Te)(t);const n=new H.A;n.timeExtent=this.timeExtent,n.geometry=e,n.outFields=a,n.outSpatialReference=e.spatialReference;const{resolution:l,spatialReference:o}=this.view,u="2d"===this.view.type?new m.A(l,l,o):new m.A(.5*l,.5*l,o),{returnTopmostRaster:p,showNoDataRecords:g}=r.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},c={returnDomainValues:!0,returnTopmostRaster:p,pixelSize:u,showNoDataRecords:g,signal:null===t||void 0===t?void 0:t.signal};return i.queryVisibleRasters(n,c)}async getSourceScale(){return await(0,D.Hh)(),await this.layer.load(),(0,D.OO)(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){var e;return!!super.canResume()&&!(null!==(e=this.timeExtent)&&void 0!==e&&e.isEmpty)}};return(0,s.Cg)([(0,n.MZ)()],i.prototype,"layer",void 0),(0,s.Cg)([(0,n.MZ)()],i.prototype,"suspended",void 0),(0,s.Cg)([(0,n.MZ)({readOnly:!0})],i.prototype,"timeExtent",null),(0,s.Cg)([(0,n.MZ)()],i.prototype,"view",void 0),i=(0,s.Cg)([(0,l.$)("esri.views.layers.ImageryLayerView")],i),i};let R=class extends(V(o.A)){constructor(){super(...arguments),this.type="imagery-3d"}get highlightOptions(){return null}get pixelData(){return null}initialize(){const e=()=>this._updatingHandles.addPromise(this.refreshDebounced());this._updatingHandles.add(()=>{var e;return null===(e=this.layer)||void 0===e||null===(e=e.exportImageServiceParameters)||void 0===e?void 0:e.version},e),this._updatingHandles.add(()=>{var e;return null===(e=this.layer)||void 0===e?void 0:e.renderer},e),this._updatingHandles.add(()=>this.timeExtent,e),this._highlightHelper=new g.r({view:this.view,layer:this.layer,updatingHandles:this._updatingHandles}),this.addHandles([(0,r.DQ)(this._highlightHelper),(0,a.wB)(()=>this.suspended,e=>this._highlightHelper.suspended=e,a.pc)])}_initSubView(){this.addHandles([(0,a.wB)(()=>this.layer.renderer,e=>this._recreateSubView(e),a.Vh)])}_recreateSubView(e){var t;const i="flow"===(null===e||void 0===e?void 0:e.type),s="flow"===(null===(t=this.subView)||void 0===t?void 0:t.type),r=this.subView;r&&i===s||(this.subView=i?new y({layerView:this}):new p({layerView:this}),null===r||void 0===r||r.destroy())}getFetchOptions(){return{timeExtent:this.timeExtent}}highlight(e,t){return this._highlightHelper.highlight(e,t)}isUpdating(){return super.isUpdating()||this._highlightHelper.updating}};(0,s.Cg)([(0,n.MZ)()],R.prototype,"highlightOptions",null),(0,s.Cg)([(0,n.MZ)()],R.prototype,"pixelData",null),R=(0,s.Cg)([(0,l.$)("esri.views.3d.layers.ImageryLayerView3D")],R);const A=R}}]);
//# sourceMappingURL=6601.f1261ac3.chunk.js.map